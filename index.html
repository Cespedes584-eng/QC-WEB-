<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #2c3e50; --accent: #468e5d; --bg: #f0f2f5;
            --white: #ffffff; --text: #333; --danger: #c0392b; --info: #2980b9;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); color: var(--text); }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; width: 320px; }
        .navbar { background: var(--primary); color: white; padding: 0 30px; display: flex; justify-content: space-between; align-items: center; height: 75px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .nav-links { display: flex; gap: 5px; align-items: center; }
        .session-info { display: flex; align-items: center; gap: 20px; background: rgba(255,255,255,0.05); padding: 5px 15px; border-radius: 8px; margin-right: 10px; }
        .user-badge { border-right: 1px solid rgba(255,255,255,0.2); padding-right: 15px; text-align: right; }
        .user-badge b { color: var(--accent); display: block; font-size: 14px; }
        .user-badge span { font-size: 11px; color: #bdc3c7; }
        .reloj-container { text-align: right; min-width: 100px; }
        #reloj { font-size: 1.2em; font-weight: bold; color: white; }
        #fecha { font-size: 0.7em; color: #bdc3c7; }
        .dropdown { position: relative; display: inline-block; }
        .dropbtn { background: none; border: none; color: #bdc3c7; padding: 15px 10px; font-size: 13px; cursor: pointer; font-weight: 500; }
        .dropdown:hover .dropbtn { color: white; background: rgba(255,255,255,0.1); }
        .dropdown-content { display: none; position: absolute; background: white; min-width: 200px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 100; border-radius: 0 0 4px 4px; }
        .dropdown-content a { color: #333; padding: 12px 16px; text-decoration: none; display: block; font-size: 13px; border-bottom: 1px solid #f0f0f0; }
        .dropdown:hover .dropdown-content { display: block; }
        .main-content { padding: 30px; display: none; max-width: 1000px; margin: 0 auto; text-align: center; }
        .grid-avisos { display: flex; flex-direction: column; gap: 30px; margin-top: 20px; }
        .card-aviso { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); text-align: left; border-top: 5px solid var(--accent); }
        .card-aviso img { width: 100%; height: auto; display: block; object-fit: contain; }
        .aviso-header { padding: 15px; background: #fff; font-weight: bold; border-bottom: 1px solid #eee; }
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-logout { background: var(--danger); color: white; font-size: 11px; }
        .btn-add { background: var(--accent); color: white; width: 100%; margin-top: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; }
        .modal-content { background: white; width: 95%; max-width: 850px; margin: 20px auto; border-radius: 12px; overflow: hidden; }
        .tab-bar { display: flex; background: #eee; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: bold; color: #666; min-width: 100px; }
        .tab-btn.active { background: white; color: var(--accent); border-bottom: 3px solid var(--accent); }
        .tab-content { padding: 20px; display: none; max-height: 75vh; overflow-y: auto; text-align: left; }
        .tab-content.active { display: block; }
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .guide-box { background: #f8f9fa; padding: 15px; border-left: 5px solid var(--info); margin-bottom: 20px; line-height: 1.6; }
        .guide-box h4 { margin-top: 0; color: var(--info); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-bottom: 20px;">QC Control</h2>
            <input type="text" id="loginUser" placeholder="Usuario">
            <input type="password" id="loginPass" placeholder="Contrase√±a">
            <button class="btn btn-add" onclick="verificarLogin()">ENTRAR</button>
            <p id="error-msg" style="color: red; font-size: 12px; margin-top: 10px; display: none;">Credenciales incorrectas</p>
        </div>
    </div>

    <div id="portal-content" style="display: none;">
        <div class="navbar">
            <div class="nav-links">
                <div style="margin-right: 15px; border-right: 1px solid rgba(255,255,255,0.2); padding-right: 15px;">
                    <span style="font-weight: 900; color: var(--accent); font-size: 1.4em;">QC</span>
                    <span style="font-weight: 300; font-size: 1.4em;">CONTROL</span>
                </div>
                <div class="dropdown"><button class="dropbtn">Herramientas ‚ñº</button><div class="dropdown-content" id="nav-modulos"></div></div>
                <div class="dropdown"><button class="dropbtn">Excel ‚ñº</button><div class="dropdown-content" id="nav-excel"></div></div>
                <div class="dropdown"><button class="dropbtn">Power BI ‚ñº</button><div class="dropdown-content" id="nav-pbi"></div></div>
                <div class="dropdown"><button class="dropbtn">PDFs ‚ñº</button><div class="dropdown-content" id="nav-pdf"></div></div>
                <div class="dropdown"><button class="dropbtn">Otros ‚ñº</button><div class="dropdown-content" id="nav-otros"></div></div>
            </div>
            
            <div style="display: flex; align-items: center;">
                <div class="session-info">
                    <div class="user-badge"><b id="display-user-name">Usuario</b><span id="display-user-id">ID: ---</span></div>
                    <div class="reloj-container"><div id="reloj">00:00:00</div><div id="fecha">...</div></div>
                </div>
                <button id="btn-admin-panel" class="btn" style="background:#556b82; color:white; font-size: 11px; display: none;" onclick="abrirPanel()">‚öô ADMIN</button>
                <button class="btn btn-logout" style="margin-left:10px;" onclick="cerrarSesion()">SALIR</button>
            </div>
        </div>

        <div class="main-content" id="main-view" style="display: block;">
            <h1 style="color: var(--primary);">Tablero Informativo</h1>
            <div class="grid-avisos" id="grid-avisos"></div>
        </div>
    </div>

    <div id="modalAdmin" class="modal">
        <div class="modal-content">
            <div class="tab-bar">
                <button class="tab-btn active" onclick="switchTab(event, 'tab-users')">Usuarios</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab-files')">Archivos</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab-news')">Avisos</button>
                <button class="tab-btn" onclick="switchTab(event, 'tab-mods')">M√≥dulos</button>
                <button class="tab-btn" style="color: var(--info);" onclick="switchTab(event, 'tab-help')">‚ùì AYUDA ADMIN</button>
                <button onclick="cerrarPanel()" style="padding:15px; border:none; background:none; cursor:pointer;">‚úï</button>
            </div>

            <div id="tab-users" class="tab-content active">
                <h4>Gesti√≥n de Usuarios</h4>
                <input type="text" id="uName" placeholder="Nombre">
                <input type="text" id="uID" placeholder="ID Empleado">
                <input type="text" id="uPass" placeholder="Clave">
                <label><input type="checkbox" id="uIsAdmin"> ¬øAdmin?</label>
                <button class="btn btn-add" onclick="saveUser()">Guardar Usuario</button>
                <table><thead><tr><th>Nombre</th><th>ID</th><th>Clave</th><th>Admin</th><th>Acci√≥n</th></tr></thead><tbody id="list-users"></tbody></table>
            </div>

            <div id="tab-files" class="tab-content">
                <h4>Recursos (Excel, PBI, PDF)</h4>
                <input type="text" id="fName" placeholder="Nombre del Archivo">
                <input type="text" id="fLink" placeholder="URL del Enlace">
                <select id="fType">
                    <option value="excel">Excel</option>
                    <option value="pbi">Power BI</option>
                    <option value="pdf">PDF</option>
                    <option value="otros">Otros</option>
                </select>
                <button class="btn btn-add" onclick="saveFile()">Agregar Recurso</button>
                <table><thead><tr><th>Tipo</th><th>Nombre</th><th>Acci√≥n</th></tr></thead><tbody id="list-files"></tbody></table>
            </div>

            <div id="tab-news" class="tab-content">
                <h4>Tablero de Avisos</h4>
                <input type="text" id="nTitle" placeholder="T√≠tulo del Aviso">
                <input type="text" id="nImg" placeholder="Link de la Imagen">
                <button class="btn btn-add" onclick="saveNews()">Publicar Aviso</button>
                <table><thead><tr><th>T√≠tulo</th><th>Acci√≥n</th></tr></thead><tbody id="list-news"></tbody></table>
            </div>

            <div id="tab-mods" class="tab-content">
                <h4>M√≥dulos Adicionales</h4>
                <input type="text" id="mName" placeholder="Nombre (Ej: Inventario)">
                <input type="text" id="mLink" placeholder="Archivo (Ej: inventario.html)">
                <button class="btn btn-add" onclick="saveMod()">A√±adir M√≥dulo</button>
                <table><thead><tr><th>M√≥dulo</th><th>Link</th><th>Acci√≥n</th></tr></thead><tbody id="list-mods"></tbody></table>
            </div>

            <div id="tab-help" class="tab-content">
                <div class="guide-box">
                    <h4>üìñ Gu√≠a de Uso para el Administrador</h4>

<p><b>1. Gesti√≥n de Usuarios:</b> Puedes crear nuevos accesos con Nombre, ID y Clave. 
<i>Importante:</i> Solo si marcas la casilla "¬øAdmin?", el usuario podr√° ver el bot√≥n de configuraci√≥n.</p>

<p><b>2. Publicaci√≥n de Recursos (Excel, PBI, PDFs):</b> El archivo debe estar en la nube (Google Drive o OneDrive) configurado como <b>"Cualquier persona con el enlace puede leer"</b>.</p>

<p><b>3. Tablero de Avisos (Im√°genes):</b> Sube la imagen a PostImages y usa exclusivamente el <b>"Enlace directo"</b> (el que termina en .jpg o .png).</p>

<p><b>4. M√≥dulos / Herramientas:</b> Aqu√≠ vinculas otros archivos HTML (ej. Producciones.html). Aseg√∫rate de que est√©n en la misma carpeta del servidor.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyDaMTlHQCVEX_p39O1VkfgXqLiYA1MqqWk",
            authDomain: "qc-control-1b547.firebaseapp.com",
            databaseURL: "https://qc-control-1b547-default-rtdb.firebaseio.com",
            projectId: "qc-control-1b547",
            storageBucket: "qc-control-1b547.firebasestorage.app",
            messagingSenderId: "995702531265",
            appId: "1:995702531265:web:9f1c47440a5ef6649b6040"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let usuariosGlobal = {};

        function actualizarReloj() {
            const ahora = new Date();
            document.getElementById('reloj').textContent = ahora.toLocaleTimeString();
            document.getElementById('fecha').textContent = ahora.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
        }
        setInterval(actualizarReloj, 1000);

       window.onload = function() {
    const sesion = localStorage.getItem('qc_session');
    if(sesion) { 
        const u = JSON.parse(sesion); 
        aplicarSesion(u.name, u.id, u.isAdmin); 
    } else {
        // Si no hay sesi√≥n, nos aseguramos de que el portal est√© oculto
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('portal-content').style.display = 'none';
    }
};

        function verificarLogin() {
            const userIn = document.getElementById('loginUser').value.trim();
            const passIn = document.getElementById('loginPass').value.trim();
            let encontrado = null;

            // 1. Caso Admin Maestro
            if(userIn === "admin" && passIn === "12345") { 
                encontrado = { name: "admin", nombre: "ADMIN", id: "MASTER", isAdmin: true }; 
            }

            // 2. Buscar en usuarios de Firebase
            Object.values(usuariosGlobal).forEach(u => { 
                if(u.name.toLowerCase() === userIn && u.pass === passIn) { 
                    encontrado = u;
                    // Agregamos 'nombre' para que el Tracker lo reconozca sin errores
                    encontrado.nombre = u.name; 
                } 
            });

            if(encontrado) { 
                // Guardamos en la memoria del navegador
                localStorage.setItem('qc_session', JSON.stringify(encontrado)); 
                
                // Aplicamos la sesi√≥n visualmente
                aplicarSesion(encontrado.name, encontrado.id, encontrado.isAdmin); 
            }
            else { 
                document.getElementById('error-msg').style.display = 'block'; 
            }
        }
        function aplicarSesion(nombre, id, isAdmin) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('portal-content').style.display = 'block';
            document.getElementById('display-user-name').textContent = nombre;
            document.getElementById('display-user-id').textContent = "ID: " + (id || "---");
            document.getElementById('btn-admin-panel').style.display = isAdmin ? 'inline-block' : 'none';
        }

       function cerrarSesion() { 
    localStorage.removeItem('qc_session'); 
    location.reload(); 
}
        // SINCRONIZACI√ìN EN TIEMPO REAL
        db.ref().on('value', snap => {
            const data = snap.val() || {};
            
            // 1. Usuarios
            usuariosGlobal = data.users || {};
            const listU = document.getElementById('list-users');
            listU.innerHTML = "";
            Object.keys(usuariosGlobal).forEach(k => {
                const u = usuariosGlobal[k];
                listU.innerHTML += `<tr><td>${u.name}</td><td>${u.id}</td><td>${u.pass}</td><td>${u.isAdmin?'‚úÖ':'‚ùå'}</td><td><button onclick="del('users/${k}')">‚úñ</button></td></tr>`;
            });

            // 2. M√≥dulos (Base + Din√°micos)
            const navMod = document.getElementById('nav-modulos'), listMod = document.getElementById('list-mods');
            navMod.innerHTML = ""; listMod.innerHTML = "";
            
            // M√≥dulos Fijos (Base)
            const fijos = [
                { nombre: "‚è± Producciones", link: "Producciones.html" },
                { nombre: "üß™ Coating", link: "Coating.html" },
                { nombre: "üìñ Document Review", link: "Document review.html" }
            ];
            fijos.forEach(m => {
                navMod.innerHTML += `<a href="${m.link}">${m.nombre}</a>`;
                listMod.innerHTML += `<tr style="color: #999"><td>${m.nombre}</td><td>Base</td><td>-</td></tr>`;
            });

            // M√≥dulos de Firebase
            const mods = data.modulos || {};
            Object.keys(mods).forEach(k => {
                navMod.innerHTML += `<a href="${mods[k].link}">${mods[k].nombre}</a>`;
                listMod.innerHTML += `<tr><td>${mods[k].nombre}</td><td>${mods[k].link}</td><td><button onclick="del('modulos/${k}')">‚úñ</button></td></tr>`;
            });

            // 3. Recursos y Avisos
            const navE = document.getElementById('nav-excel'), navP = document.getElementById('nav-pbi'), navPdf = document.getElementById('nav-pdf'), navO = document.getElementById('nav-otros');
            const listF = document.getElementById('list-files'), listN = document.getElementById('list-news'), grid = document.getElementById('grid-avisos');
            
            navE.innerHTML = ""; navP.innerHTML = ""; navPdf.innerHTML = ""; navO.innerHTML = ""; 
            listF.innerHTML = ""; listN.innerHTML = ""; grid.innerHTML = "";
            
            const recs = data.recursos || {};
            Object.keys(recs).forEach(k => {
                const r = recs[k];
                if(r.tipo === 'aviso') {
                    grid.innerHTML += `<div class="card-aviso"><div class="aviso-header">${r.nombre}</div><img src="${r.link}"></div>`;
                    listN.innerHTML += `<tr><td>${r.nombre}</td><td><button onclick="del('recursos/${k}')">‚úñ</button></td></tr>`;
                } else {
                    const l = `<a href="${r.link}" target="_blank">${r.nombre}</a>`;
                    if(r.tipo === 'excel') navE.innerHTML += l;
                    else if(r.tipo === 'pbi') navP.innerHTML += l;
                    else if(r.tipo === 'pdf') navPdf.innerHTML += l;
                    else navO.innerHTML += l;
                    listF.innerHTML += `<tr><td>${r.tipo.toUpperCase()}</td><td>${r.nombre}</td><td><button onclick="del('recursos/${k}')">‚úñ</button></td></tr>`;
                }
            });
        });

        // FUNCIONES ADMIN
       function saveUser() { 
    const n = document.getElementById('uName').value; 
    const i = document.getElementById('uID').value; 
    const p = document.getElementById('uPass').value; 
    const a = document.getElementById('uIsAdmin').checked; 

    if(n && i && p) { 
        // Esto guarda al usuario usando su ID como nombre de carpeta
        db.ref('users/' + i).set({ 
            name: n, 
            id: i, 
            pass: p, 
            isAdmin: a 
        }).then(() => {
            alert("Usuario " + n + " guardado con √©xito. Ya puede iniciar sesi√≥n.");
            clearInputs(['uName', 'uID', 'uPass']); 
        }).catch(error => {
            alert("Error al guardar en Firebase: " + error.message);
        });
    } else {
        alert("Por favor completa: Nombre, ID y Clave");
    }
}
        function saveFile() { 
            const n = document.getElementById('fName').value, l = document.getElementById('fLink').value, t = document.getElementById('fType').value; 
            if(n && l) { db.ref('recursos').push({nombre:n, link:l, tipo:t}); clearInputs(['fName', 'fLink']); }
        }
        function saveNews() { 
            const t = document.getElementById('nTitle').value, i = document.getElementById('nImg').value; 
            if(t && i) { db.ref('recursos').push({nombre:t, link:i, tipo:'aviso'}); clearInputs(['nTitle', 'nImg']); }
        }
        function saveMod() { 
            const n = document.getElementById('mName').value, l = document.getElementById('mLink').value; 
            if(n && l) { db.ref('modulos').push({nombre:n, link:l}); clearInputs(['mName', 'mLink']); }
        }

        function clearInputs(ids) { ids.forEach(id => document.getElementById(id).value = ""); }
        function del(p) { if(confirm('¬øEliminar este registro definitivamente?')) db.ref(p).remove(); }
        function abrirPanel() { document.getElementById('modalAdmin').style.display = 'block'; }
        function cerrarPanel() { document.getElementById('modalAdmin').style.display = 'none'; }
        function switchTab(e, id) { 
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); e.currentTarget.classList.add('active'); 
        }
    </script>
</body>
</html>