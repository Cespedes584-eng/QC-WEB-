<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Tracker</title>
    <style>
        :root {
            /* Paleta unificada con el Dashboard */
            --bg-body: #ebedef;
            --panel-bg: #ffffff;
            --primary-dark: #24303c;
            --primary-green: #468e5d;
            --alert-red: #da3633;
            --text-dark: #333333;
            --border: #d1d8d5;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-dark);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
        }

        .header {
            background: var(--primary-dark);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-green);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .card.inspeccionando {
            border: 2px solid var(--primary-green);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: var(--primary-green);
            padding: 12px;
            font-weight: bold;
            text-align: center;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .lote-destacado {
            font-size: 1.4em;
            font-weight: 800;
            margin: 5px 0;
            color: var(--primary-dark);
        }

        .badge-info {
            font-size: 0.75em;
            margin-bottom: 8px;
            color: var(--primary-green);
        }

        .badge-info span {
            background: #f0f4f1;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #d1d8d5;
        }

        .timer-display {
            font-family: monospace;
            font-size: 1.7em;
            color: var(--primary-green);
            font-weight: bold;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .btn-card {
            border: none;
            padding: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
        }

        .btn-terminar {
            background: #2e7d32;
            color: #fff;
        }

        .btn-historial {
            background: #ffffff;
            color: var(--primary-green);
            border-top: 1px solid #eee;
        }

        .btn-main {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }

        .modal,
        .airport-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 4000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 25px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .airport-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .airport-table th {
            background: #f1f3f5;
            padding: 10px;
            border-bottom: 2px solid var(--primary-green);
            color: var(--primary-dark);
        }

        .airport-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary-green);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: 0.3s;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .search-bar {
            background: #fff;
            border: 1px solid var(--border);
            padding: 12px;
            margin-bottom: 15px;
            font-size: 1em;
            border-radius: 4px;
        }

        .btn-excel-header {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        #reloj {
            font-family: monospace;
            font-size: 1.1em;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-back {
            background: #455a64;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>

<body onload="inicializarSistema()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-back" onclick="location.href='index.html'">üè† VOLVER</button>
            <button id="btn-admin-access" class="btn-main" style="background:#5c6bc0; display: none;" onclick="abrirAdmin()">‚öôÔ∏è ADMIN</button>
            <span style="font-weight: 800; color: white; font-size: 1.2em; letter-spacing: 1px;">QC TRACKER V13.8</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="user-display" class="user-info">USUARIO</div>
            <button class="btn-excel-header" onclick="exportarExcelGeneral()">üìä EXCEL</button>
            <div id="reloj">00:00:00</div>
        </div>
    </div>

    <div id="pizarra" class="grid-container"></div>

    <div class="fab" onclick="abrirModal('modal-reg')">+</div>

    <div id="modal-reg" class="modal">
        <div class="modal-content">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-reg')">√ó</button>
            <h3>Nueva Inspecci√≥n</h3>
            <label>L√≠nea</label><select id="r-linea" onchange="verificarHibrida()"></select>
            <div id="contenedor-hibrida" style="display:none; background: #f0f4f1; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid var(--border);">
                <label>Producto Espec√≠fico:</label><select id="r-producto-especifico"></select>
            </div>
            <input type="text" id="r-lote" placeholder="Lote #">
            <input type="text" id="r-inspector" readonly style="background:#f1f1f1;">
            <select id="r-proceso"></select>
            <select id="r-ansi">
                <option>Normal</option>
                <option>Reducido</option>
                <option>Riguroso</option>
            </select>
            <button class="btn-main" style="width:100%;" onclick="iniciarLote()">INICIAR INSPECCI√ìN</button>
        </div>
    </div>

    <div id="modal-admin" class="airport-modal">
        <div style="background: white; margin: 10px auto; width: 98%; max-width: 1150px; border-radius: 8px; padding: 25px; height: 90vh; overflow-y: auto; position: relative;">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-admin')">√ó</button>
            <h2 style="color:var(--primary-dark); margin-top:0;">Panel de Control Admin</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <button class="btn-main" style="height: 45px;" onclick="mostrarTab('yield')">üìä Rendimiento Yield</button>
                <button class="btn-main" style="height: 45px;" onclick="mostrarTab('gestion')">‚öôÔ∏è Gesti√≥n de Datos</button>
                <button class="btn-main" style="height: 45px; background: #6c757d;" onclick="mostrarTab('defectos')">üõ†Ô∏è Config. Defectos</button>
            </div>

            <div id="sec-yield">
                <input type="text" id="busqueda-inspector" class="search-bar" placeholder="üîç Buscar Inspector..." onkeyup="filtrarYield()">
                <div style="margin-bottom:10px;">
                    <button class="btn-main" onclick="filtrarPorFecha('hoy')">HOY</button>
                    <button class="btn-main" onclick="filtrarPorFecha('todos')">TODO</button>
                    <span id="rango-actual">üìç Viendo: Todo</span>
                </div>
                <table class="airport-table">
                    <thead>
                        <tr>
                            <th>Inspector</th>
                            <th>Aceptados</th>
                            <th>Rechazados</th>
                            <th>Total</th>
                            <th>Yield %</th>
                        </tr>
                    </thead>
                    <tbody id="yield-table-body"></tbody>
                </table>
            </div>

            <div id="sec-gestion" style="display:none;">
                <input type="text" id="input-busqueda" class="search-bar" placeholder="üîç Buscar por Lote # ..." onkeyup="filtrarLotesAdmin()">
                <table class="airport-table">
                    <thead>
                        <tr>
                            <th>Lote</th>
                            <th>Proceso</th>
                            <th>ANSI</th>
                            <th>Resultado</th>
                            <th>Detalle</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="gestion-table-body"></tbody>
                </table>
            </div>

            <div id="sec-defectos" style="display:none;">
                <h3>Configuraci√≥n de Defectos</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <select id="admin-def-linea" onchange="renderizarListaDefectosAdmin()"></select>
                    <select id="admin-def-proceso" onchange="renderizarListaDefectosAdmin()">
                        <option value="Shaft">Shaft</option>
                        <option value="Final">Final</option>
                        <option value="HubBonding">Hub Bonding</option>
                        <option value="Pre-Empaque">Pre-Empaque</option>
                    </select>
                    <input type="text" id="admin-def-nombre" placeholder="Nuevo Defecto...">
                </div>
                <button class="btn-main" style="width:100%; margin-bottom:20px;" onclick="agregarDefectoNuevo()">Ôºã GUARDAR DEFECTO</button>
                <table class="airport-table">
                    <thead>
                        <tr>
                            <th>Defecto</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-defectos-configurados-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-fin" class="modal">
        <div class="modal-content">
            <h3>¬øLote Aceptado?</h3>
            <button class="btn-main" style="width:100%;" onclick="finalizarLote(true)">ACEPTAR</button>
            <button class="btn-main" style="background:var(--alert-red); width:100%; margin-top:10px;" onclick="abrirRechazos()">RECHAZAR</button>
        </div>
    </div>

    <div id="modal-rechazos" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--alert-red);">Defectos Detectados</h3>
            <label>Piezas rechazadas:</label>
            <input type="number" id="rech-qty" value="1" min="1" onchange="generarDefectos()">
            <div id="contenedor-defectos"></div>
            <button class="btn-main" style="background:var(--alert-red); width:100%;" onclick="finalizarLote(false)">GUARDAR RECHAZO</button>
        </div>
    </div>

    <div id="modal-defecto-admin" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--alert-red);">Cambiar a Rechazado</h3>
            <input type="number" id="rech-qty-admin" value="1" min="1" onchange="generarDefectosAdmin()">
            <div id="contenedor-defectos-admin"></div>
            <button class="btn-main" onclick="confirmarCambioRechazo()">ACTUALIZAR</button>
            <button class="btn-main" style="background:#ccc;" onclick="cerrarModal('modal-defecto-admin')">CANCELAR</button>
        </div>
    </div>

    <div id="modal-historial-linea" class="airport-modal">
        <div style="background: white; margin: 20px auto; width: 95%; max-width: 1000px; border-radius: 8px; padding: 25px; height: 80vh; overflow-y: auto; position: relative;">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-historial-linea')">√ó</button>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="hist-linea-titulo"></h3>
                <button id="btn-descarga-individual" class="btn-excel-header">üì• DESCARGAR</button>
            </div>
            <input type="text" id="busqueda-lote-historial" class="search-bar" placeholder="üîç Filtrar Lote..." onkeyup="filtrarLoteHistorialIndividual()">
            <table class="airport-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Lote</th>
                        <th>Proceso</th>
                        <th>ANSI</th>
                        <th>Inspector</th>
                        <th>Resultado</th>
                        <th>Tiempo</th>
                        <th>Detalle</th>
                    </tr>
                </thead>
                <tbody id="hist-linea-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        let pausaSincro = false;
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbwBnpP2Y-hZCEoX-jNmE5GPepfcLmiGvrYpigDeICenrG6M81mITLiYHlDxkrCYgs95/exec";
        const lineasArr = ["SOFIA 6F L1", "SOFIA 6F L2 / 5F L2", "SOFIA 6F L3 / EX", "SOFIA 5F / SOFIA 6F L2", "VIA / HW 27", "SCEPTER", "HW LONG", "HW SHORT / REGULAR L2", "HW 21 +", "HW REGULAR"];

        let catalogoDefectos = JSON.parse(localStorage.getItem('qc_catalogo_v2')) || {};
        let estados = [];
        let dbHistorial = [];
        let indexSel = null;
        let adminEditTemp = { idx: null, valor: null };

        function guardarCatalogo() {
            localStorage.setItem('qc_catalogo_v2', JSON.stringify(catalogoDefectos));
            const payload = { action: 'save_config', datos: catalogoDefectos };
            fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }

        function inicializarSistema() {
            const sesion = localStorage.getItem('qc_session');
            if (sesion) {
                const data = JSON.parse(sesion);
                document.getElementById('user-display').innerText = `üë§ ${data.name}`;
                document.getElementById('r-inspector').value = data.name.toUpperCase();
                if (data.isAdmin) document.getElementById('btn-admin-access').style.display = 'inline-block';
            }

            const fechaHoy = new Date().toLocaleDateString();
            const ultimaFecha = localStorage.getItem('qc_ultima_fecha');
            const localRespaldo = localStorage.getItem('qc_v13_respaldo');

            if (ultimaFecha !== fechaHoy) {
                localStorage.removeItem('qc_v13_respaldo');
                localStorage.setItem('qc_ultima_fecha', fechaHoy);
                estados = lineasArr.map(nom => ({ activo: false, lote: '', inspector: '', inicio: null, horaInicioReal: '', tiempo: '00:00', productoActivo: nom.split(" / ")[0].trim(), productoOriginal: nom, proceso: 'Final', ansi: 'Normal' }));
            } else {
                estados = localRespaldo ? JSON.parse(localRespaldo) : lineasArr.map(nom => ({ activo: false, lote: '', inspector: '', inicio: null, horaInicioReal: '', tiempo: '00:00', productoActivo: nom.split(" / ")[0].trim(), productoOriginal: nom, proceso: 'Final', ansi: 'Normal' }));
            }

            const selL = document.getElementById('r-linea');
            selL.innerHTML = lineasArr.map((n, i) => `<option value="${i}">${n}</option>`).join('');

            cargarHistorialNube();
            render();
            setInterval(tick, 1000);
            setInterval(sincronizarConNube, 3000);
        }

        async function cargarHistorialNube() {
            try {
                const res = await fetch(SHEETS_URL);
                const datos = await res.json();
                dbHistorial = datos.historial || [];
                render();
            } catch (e) { console.error("Error historial", e); }
        }

        function render() {
    const p = document.getElementById('pizarra');
    if (!p) return;

    p.innerHTML = estados.map((s, i) => {
        const turnos = obtenerConteosTurnos(lineasArr[i]);
        
        // CORRECCI√ìN: Si no hay producto activo, mostrar el nombre de la l√≠nea
        const tituloCard = s.activo ? s.productoActivo : lineasArr[i];
        
        return `
        <div class="card ${s.activo ? 'inspeccionando' : ''}">
            <div class="card-header">${tituloCard}</div>
            
            <div style="display: flex; background: #f8f9fa; font-size: 0.8em; padding: 5px; border-bottom: 1px solid #eee;">
                <div style="flex:1; text-align:center;">A: ${turnos.ta}</div>
                <div style="flex:1; text-align:center;">B: ${turnos.tb}</div>
            </div>

            <div class="card-body">
                ${s.activo ? `
                    <div>üë§ ${s.inspector}</div>
                    <div class="lote-destacado">${s.lote}</div>
                    <div class="badge-info">
                        <span>${s.proceso}</span> ‚Ä¢ <span>${s.ansi}</span>
                    </div>
                   <div class="timer-display" id="t-${i}">${document.getElementById(`t-${i}`) ? document.getElementById(`t-${i}`).innerText : s.tiempo}</div>
                ` : `
                   
                `}
            </div>

            <div class="card-footer">
                ${s.activo ? 
                    `<button class="btn-card btn-terminar" onclick="prepararFin(${i})">TERMINAR</button>` : 
                    `<button class="btn-card btn-historial" onclick="abrirHistorialIndividual(${i})">HISTORIAL</button>`
                }
            </div>
        </div>`;
    }).join('');

    // Guardamos respaldo local
    localStorage.setItem('qc_v13_respaldo', JSON.stringify(estados));
}

        function obtenerConteosTurnos(nombreLinea) {
            let conteo = { ta: 0, tb: 0 };
            const hoy = new Date().toLocaleDateString();
            dbHistorial.forEach(r => {
                if (r.linea === nombreLinea && r.fecha === hoy) {
                    const hrs = parseInt(r.hora?.split(':')[0] || 0);
                    if (hrs >= 6 && hrs < 15.5) conteo.ta++;
                    else conteo.tb++;
                }
            });
            return conteo;
        }

        function tick() {
            estados.forEach((s, i) => {
                if (s.activo) {
                    const d = Math.floor((Date.now() - s.inicio) / 1000);
                    s.tiempo = `${Math.floor(d / 60).toString().padStart(2, '0')}:${(d % 60).toString().padStart(2, '0')}`;
                    const el = document.getElementById(`t-${i}`);
                    if (el) el.innerText = s.tiempo;
                }
            });
            document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
        }

        function abrirModal(id) {
            document.getElementById(id).style.display = 'block';
            pausaSincro = true;
            if (id === 'modal-reg') verificarHibrida();
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
            pausaSincro = false;
        }

        function iniciarLote() {
            const inputLote = document.getElementById('r-lote');
            if (!inputLote.value.trim()) return alert("Ingrese Lote");
            const idx = document.getElementById('r-linea').value;
            const s = estados[idx];
            const ahora = new Date();
            s.activo = true;
            s.lote = inputLote.value.trim();
            s.inicio = ahora.getTime();
            s.horaInicioReal = `${ahora.getHours().toString().padStart(2, '0')}:${ahora.getMinutes().toString().padStart(2, '0')}`;
            s.inspector = document.getElementById('r-inspector').value;
            s.proceso = document.getElementById('r-proceso').value;
            s.ansi = document.getElementById('r-ansi').value;
            s.productoActivo = (document.getElementById('contenedor-hibrida').style.display === 'block') ? document.getElementById('r-producto-especifico').value : lineasArr[idx];
            inputLote.value = "";
            cerrarModal('modal-reg');
            render();
            guardarEstadoPizarraEnNube();
        }

async function finalizarLote(ok) {
    const s = estados[indexSel];
    if (!s || !s.activo) return;

    pausaSincro = true; 
    s.loteAnterior = s.lote; 

    const ahora = new Date();
    
    // --- NUEVO: CAPTURAMOS LA HORA DE CIERRE ---
    const horaFin = ahora.getHours().toString().padStart(2, '0') + ':' + 
                    ahora.getMinutes().toString().padStart(2, '0');

    const registro = {
        action: 'add', 
        fecha: ahora.toLocaleDateString('es-ES'), 
        horaFin: horaFin, // <--- SE AGREGA AL REGISTRO
        hora: s.horaInicioReal,
        linea: lineasArr[indexSel], 
        producto: s.productoActivo, 
        inspector: s.inspector,
        lote: "'" + s.lote, 
        proceso: s.proceso, 
        ansi: s.ansi, 
        tiempo: s.tiempo,
        resultado: ok ? "ACEPTADO" : "RECHAZADO", 
        detalle: ok ? "OK" : Array.from(document.querySelectorAll('.m-rechazo')).map(sel => sel.value).join(", ")
    };

    // --- LIMPIEZA LOCAL INMEDIATA ---
    s.activo = false; 
    s.lote = "";
    s.productoActivo = ""; 
    s.inicio = null;
    s.tiempo = "00:00:00";

    cerrarModal('modal-fin');
    cerrarModal('modal-rechazos');
    render(); 

    try {
        await Promise.all([
            fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(registro) }),
            guardarEstadoPizarraEnNube()
        ]);
        
        dbHistorial.push(registro);
        console.log("Lote finalizado con hora:", horaFin);
    } catch (e) { 
        console.error("Error al finalizar lote:", e); 
    } finally { 
        setTimeout(() => { pausaSincro = false; }, 4000); 
    }
}

        function verificarHibrida() {
            const idx = document.getElementById('r-linea').value;
            const nom = lineasArr[idx];
            const cont = document.getElementById('contenedor-hibrida');
            if (nom.includes(" / ")) {
                document.getElementById('r-producto-especifico').innerHTML = nom.split(" / ").map(p => `<option value="${p.trim()}">${p.trim()}</option>`).join('');
                cont.style.display = 'block';
            } else cont.style.display = 'none';

            let opciones = `<option value="Shaft">Shaft</option><option value="Final">Final</option><option value="HubBonding">Hub Bonding</option><option value="Pre-Empaque">Pre-Empaque</option>`;
            if (nom.toUpperCase().includes("SCEPTER")) opciones += `<option value="Guidewire">Guidewire</option>`;
            document.getElementById('r-proceso').innerHTML = opciones;
        }

        function generarDefectos() {
            const q = parseInt(document.getElementById('rech-qty').value) || 1;
            const c = document.getElementById('contenedor-defectos');
            const s = estados[indexSel];
            let lista = (catalogoDefectos[s.productoOriginal] && catalogoDefectos[s.productoOriginal][s.proceso]) ? catalogoDefectos[s.productoOriginal][s.proceso] : ["Visual", "Derrame", "Medida", "Otro"];
            c.innerHTML = Array.from({ length: q }).map((_, i) => `<select class="m-rechazo">${lista.map(d => `<option value="${d}">${d}</option>`).join('')}</select>`).join('');
        }

async function sincronizarConNube() {
    if (pausaSincro || document.querySelector('.modal[style*="block"]')) return;

    try {
        const res = await fetch(SHEETS_URL);
        const data = await res.json();
        
        if (data.historial) dbHistorial = data.historial;
        if (data.pizarra) {
            let huboCambio = false;
            data.pizarra.forEach((n, i) => {
                // Protecci√≥n: No aceptamos un lote de la nube que coincida con el que acabamos de cerrar
                if (estados[i].activo === false && n.activo === true && n.lote === estados[i].loteAnterior) {
                    return; 
                }

                if (JSON.stringify(estados[i]) !== JSON.stringify(n)) {
                    // Si se est√° desactivando, guardamos memoria del lote para que no reviva
                    if (estados[i].activo === true && n.activo === false) {
                        estados[i].loteAnterior = estados[i].lote;
                    }
                    estados[i] = n;
                    huboCambio = true;
                }
            });
            if (huboCambio) render();
        }
    } catch (e) { console.error("Error Sync:", e); }
}

        function mostrarTab(t) {
            ['sec-yield', 'sec-gestion', 'sec-defectos'].forEach(id => document.getElementById(id).style.display = id.includes(t) ? 'block' : 'none');
            if (t === 'defectos') inicializarSelectoresAdmin();
            if (t === 'yield') generarReporteYield();
            if (t === 'gestion') generarGestionLotes();
        }

        function inicializarSelectoresAdmin() {
            document.getElementById('admin-def-linea').innerHTML = lineasArr.map(n => `<option value="${n}">${n}</option>`).join('');
            renderizarListaDefectosAdmin();
        }

        function renderizarListaDefectosAdmin() {
            const l = document.getElementById('admin-def-linea').value;
            const p = document.getElementById('admin-def-proceso').value;
            const lista = (catalogoDefectos[l] && catalogoDefectos[l][p]) ? catalogoDefectos[l][p] : [];
            document.getElementById('lista-defectos-configurados-tabla').innerHTML = lista.map((d, i) => `<tr><td>${d}</td><td><button onclick="eliminarDefecto('${l}','${p}',${i})">üóëÔ∏è</button></td></tr>`).join('');
        }

        function agregarDefectoNuevo() {
            const l = document.getElementById('admin-def-linea').value;
            const p = document.getElementById('admin-def-proceso').value;
            const v = document.getElementById('admin-def-nombre').value.trim();
            if (!v) return;
            if (!catalogoDefectos[l]) catalogoDefectos[l] = {};
            if (!catalogoDefectos[l][p]) catalogoDefectos[l][p] = [];
            catalogoDefectos[l][p].push(v);
            guardarCatalogo();
            document.getElementById('admin-def-nombre').value = "";
            renderizarListaDefectosAdmin();
        }

        function eliminarDefecto(l, p, i) {
            catalogoDefectos[l][p].splice(i, 1);
            guardarCatalogo();
            renderizarListaDefectosAdmin();
        }

        function generarReporteYield() {
            const stats = {};
            dbHistorial.forEach(r => {
                const ins = r.inspector || "N/A";
                if (!stats[ins]) stats[ins] = { ok: 0, fail: 0, total: 0 };
                stats[ins].total++;
                if (r.resultado === 'ACEPTADO') stats[ins].ok++; else stats[ins].fail++;
            });
            document.getElementById('yield-table-body').innerHTML = Object.keys(stats).map(k => {
                const d = stats[k];
                const y = ((d.ok / d.total) * 100).toFixed(1);
                return `<tr><td>${k}</td><td>${d.ok}</td><td>${d.fail}</td><td>${d.total}</td><td>${y}%</td></tr>`;
            }).join('');
        }

        function generarGestionLotes() {
            const tbody = document.getElementById('gestion-table-body');
            tbody.innerHTML = [...dbHistorial].reverse().slice(0, 50).map((r, i) => `
                <tr>
                    <td>${r.lote}</td>
                    <td>${r.proceso}</td>
                    <td>${r.ansi}</td>
                    <td>${r.resultado}</td>
                    <td>${r.detalle}</td>
                    <td><button onclick="borrarRegistro(${dbHistorial.length - 1 - i})">üóëÔ∏è</button></td>
                </tr>`).join('');
        }

        async function borrarRegistro(idx) {
            if (!confirm("¬øEliminar registro?")) return;
            const r = dbHistorial[idx];
            fetch(SHEETS_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', lote: r.lote, fecha: r.fecha, hora: r.hora }) });
            dbHistorial.splice(idx, 1);
            generarGestionLotes();
        }

        function prepararFin(i) {
            indexSel = i;
            const sesion = JSON.parse(localStorage.getItem('qc_session'));
            if (estados[i].inspector.includes(sesion.name.toUpperCase()) || sesion.isAdmin) {
                abrirModal('modal-fin');
            } else alert("Solo el responsable puede finalizar.");
        }

        function abrirRechazos() { cerrarModal('modal-fin'); abrirModal('modal-rechazos'); generarDefectos(); }

        function exportarExcelGeneral() {
            let csv = "\uFEFFsep=;\nFecha;Hora;Linea;Producto;Inspector;Lote;Proceso;ANSI;Resultado;Tiempo;Detalle\n";
            dbHistorial.forEach(r => {
                csv += `${r.fecha};${r.hora};${r.linea};${r.producto};${r.inspector};${r.lote};${r.proceso};${r.ansi};${r.resultado};${r.tiempo};${r.detalle}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Reporte_QC.csv";
            link.click();
        }

        function abrirAdmin() { abrirModal('modal-admin'); mostrarTab('yield'); }
        
        function abrirHistorialIndividual(idx) {
    const nom = lineasArr[idx];
    document.getElementById('hist-linea-titulo').innerText = "Historial: " + nom;
    const filtrados = dbHistorial.filter(r => r.linea === nom).reverse();
    
    document.getElementById('hist-linea-body').innerHTML = filtrados.map(r => `
        <tr>
            <td style="line-height: 1.2; min-width: 90px;">
                ${r.fecha} <br> 
                <span style="font-size: 0.85em; color: #555; font-weight: bold;">
                    üèÅ ${r.horaFin || '--:--'}
                </span>
            </td>
            <td>${r.lote}</td>
            <td>${r.proceso}</td>
            <td>${r.ansi}</td>
            <td>${r.inspector}</td>
            <td style="font-weight: bold; color: ${r.resultado === 'ACEPTADO' ? '#28a745' : '#dc3545'};">
                ${r.resultado}
            </td>
            <td>${r.tiempo}</td>
            <td>${r.detalle}</td>
        </tr>`).join('');
        
    abrirModal('modal-historial-linea');
}
async function guardarEstadoPizarraEnNube() {
    try {
        const sesion = JSON.parse(localStorage.getItem('qc_session'));
        const payload = { 
            action: 'save_pizarra', 
            estados: estados, 
            lastUpdateBy: sesion?.name || "Sistema" 
        };
        
        console.log("Sincronizando pizarra con la nube...");
        
        return await fetch(SHEETS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(payload) 
        });
    } catch (error) {
        console.error("Error cr√≠tico en guardarEstadoPizarraEnNube:", error);
    }
}    
</script>
</body>
</html>