<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Tracker</title>
    <style>
        :root {
            /* Paleta unificada con el Dashboard */
            --bg-body: #ebedef;
            --panel-bg: #ffffff;
            --primary-dark: #24303c;
            --primary-green: #468e5d;
            --alert-red: #da3633;
            --text-dark: #333333;
            --border: #d1d8d5;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-dark);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
        }

        .header {
            background: var(--primary-dark);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-green);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            color: white;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 320px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: 0.2s;
        }

        .card.inspeccionando {
            border: 2px solid var(--primary-green);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background: var(--primary-green);
            padding: 12px;
            font-weight: bold;
            text-align: center;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-body {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }

        .lote-destacado {
            font-size: 1.4em;
            font-weight: 800;
            margin: 5px 0;
            color: var(--primary-dark);
        }

        .badge-info {
            font-size: 0.75em;
            margin-bottom: 8px;
            color: var(--primary-green);
        }

        .badge-info span {
            background: #f0f4f1;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #d1d8d5;
        }

        .timer-display {
            font-family: monospace;
            font-size: 1.7em;
            color: var(--primary-green);
            font-weight: bold;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .btn-card {
            border: none;
            padding: 12px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: 0.3s;
        }

        .btn-terminar {
            background: #2e7d32;
            color: #fff;
        }

        .btn-historial {
            background: #ffffff;
            color: var(--primary-green);
            border-top: 1px solid #eee;
        }

        .btn-main {
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 10px 18px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }

        .modal,
        .airport-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
            z-index: 4000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 500px;
            margin: 50px auto;
            padding: 25px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .airport-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .airport-table th {
            background: #f1f3f5;
            padding: 10px;
            border-bottom: 2px solid var(--primary-green);
            color: var(--primary-dark);
        }

        .airport-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
        }

        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary-green);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 35px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: 0.3s;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }

        .search-bar {
            background: #fff;
            border: 1px solid var(--border);
            padding: 12px;
            margin-bottom: 15px;
            font-size: 1em;
            border-radius: 4px;
        }

        .btn-excel-header {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        #reloj {
            font-family: monospace;
            font-size: 1.1em;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-back {
            background: #455a64;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>

<body onload="inicializarSistema()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-back" onclick="location.href='index.html'">üè† VOLVER</button>
            <button id="btn-admin-access" class="btn-main" style="background:#5c6bc0; display: none;" onclick="abrirAdmin()">‚öôÔ∏è ADMIN</button>
            <span style="font-weight: 800; color: white; font-size: 1.2em; letter-spacing: 1px;">QC TRACKER V13.8</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="user-display" class="user-info">USUARIO</div>
            <button class="btn-excel-header" onclick="exportarExcelGeneral()">üìä EXCEL</button>
            <div id="reloj">00:00:00</div>
        </div>
    </div>

    <div id="pizarra" class="grid-container"></div>

    <div class="fab" onclick="abrirModal('modal-reg')">+</div>

    <div id="modal-reg" class="modal">
        <div class="modal-content">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-reg')">√ó</button>
            <h3>Nueva Inspecci√≥n</h3>
            <label>L√≠nea</label><select id="r-linea" onchange="verificarHibrida()"></select>
            <div id="contenedor-hibrida" style="display:none; background: #f0f4f1; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid var(--border);">
                <label>Producto Espec√≠fico:</label><select id="r-producto-especifico"></select>
            </div>
            <input type="text" id="r-lote" placeholder="Lote #">
            <input type="text" id="r-inspector" readonly style="background:#f1f1f1;">
            <select id="r-proceso"></select>
            <select id="r-ansi">
                <option>Normal</option>
                <option>Reducido</option>
                <option>Riguroso</option>
            </select>
            <button class="btn-main" style="width:100%;" onclick="iniciarLote()">INICIAR INSPECCI√ìN</button>
        </div>
    </div>

    <div id="modal-admin" class="airport-modal">
        <div style="background: white; margin: 10px auto; width: 98%; max-width: 1150px; border-radius: 8px; padding: 25px; height: 90vh; overflow-y: auto; position: relative;">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-admin')">√ó</button>
            <h2 style="color:var(--primary-dark); margin-top:0;">Panel de Control Admin</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                <button class="btn-main" style="height: 45px;" onclick="mostrarTab('yield')">üìä Rendimiento Yield</button>
                <button class="btn-main" style="height: 45px;" onclick="mostrarTab('gestion')">‚öôÔ∏è Gesti√≥n de Datos</button>
                <button class="btn-main" style="height: 45px; background: #6c757d;" onclick="mostrarTab('defectos')">üõ†Ô∏è Config. Defectos</button>
            </div>

            <div id="sec-yield">
                <input type="text" id="busqueda-inspector" class="search-bar" placeholder="üîç Buscar Inspector..." onkeyup="filtrarYield()">
                <div style="margin-bottom:10px;">
                    <button class="btn-main" onclick="filtrarPorFecha('hoy')">HOY</button>
                    <button class="btn-main" onclick="filtrarPorFecha('todos')">TODO</button>
                    <span id="rango-actual">üìç Viendo: Todo</span>
                </div>
                <table class="airport-table">
                    <thead>
                        <tr>
                            <th>Inspector</th>
                            <th>Aceptados</th>
                            <th>Rechazados</th>
                            <th>Total</th>
                            <th>Yield %</th>
                        </tr>
                    </thead>
                    <tbody id="yield-table-body"></tbody>
                </table>
            </div>

            <div id="sec-gestion" style="display:none;">
                <input type="text" id="input-busqueda" class="search-bar" placeholder="üîç Buscar por Lote # ..." onkeyup="filtrarLotesAdmin()">
                <table class="airport-table">
                    <thead>
                        <tr>
                            <th>Lote</th>
                            <th>Proceso</th>
                            <th>ANSI</th>
                            <th>Resultado</th>
                            <th>Detalle</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="gestion-table-body"></tbody>
                </table>
            </div>

            <div id="sec-defectos" style="display:none;">
                <h3>Configuraci√≥n de Defectos</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <select id="admin-def-linea" onchange="renderizarListaDefectosAdmin()"></select>
                    <select id="admin-def-proceso" onchange="renderizarListaDefectosAdmin()">
                        <option value="Shaft">Shaft</option>
                        <option value="Final">Final</option>
                        <option value="HubBonding">Hub Bonding</option>
                        <option value="Pre-Empaque">Pre-Empaque</option>
                    </select>
                    <input type="text" id="admin-def-nombre" placeholder="Nuevo Defecto...">
                </div>
                <button class="btn-main" style="width:100%; margin-bottom:20px;" onclick="agregarDefectoNuevo()">Ôºã GUARDAR DEFECTO</button>
                <table class="airport-table">
                    <thead>
                        <tr>
                            <th>Defecto</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="lista-defectos-configurados-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-fin" class="modal">
        <div class="modal-content">
            <h3>¬øLote Aceptado?</h3>
            <button class="btn-main" style="width:100%;" onclick="finalizarLote(true)">ACEPTAR</button>
            <button class="btn-main" style="background:var(--alert-red); width:100%; margin-top:10px;" onclick="abrirRechazos()">RECHAZAR</button>
        </div>
    </div>

    <div id="modal-rechazos" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--alert-red);">Defectos Detectados</h3>
            <label>Piezas rechazadas:</label>
            <input type="number" id="rech-qty" value="1" min="1" onchange="generarDefectos()">
            <div id="contenedor-defectos"></div>
            <button class="btn-main" style="background:var(--alert-red); width:100%;" onclick="finalizarLote(false)">GUARDAR RECHAZO</button>
        </div>
    </div>

    <div id="modal-defecto-admin" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--alert-red);">Cambiar a Rechazado</h3>
            <input type="number" id="rech-qty-admin" value="1" min="1" onchange="generarDefectosAdmin()">
            <div id="contenedor-defectos-admin"></div>
            <button class="btn-main" onclick="confirmarCambioRechazo()">ACTUALIZAR</button>
            <button class="btn-main" style="background:#ccc;" onclick="cerrarModal('modal-defecto-admin')">CANCELAR</button>
        </div>
    </div>

    <div id="modal-historial-linea" class="airport-modal">
        <div style="background: white; margin: 20px auto; width: 95%; max-width: 1000px; border-radius: 8px; padding: 25px; height: 80vh; overflow-y: auto; position: relative;">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-historial-linea')">√ó</button>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="hist-linea-titulo"></h3>
                <button id="btn-descarga-individual" onclick="exportarHistorialIndividual()" class="btn-excel-header">üì• DESCARGAR</button>
            </div>
            <input type="text" id="busqueda-lote-historial" class="search-bar" placeholder="üîç Filtrar Lote..." onkeyup="filtrarLoteHistorialIndividual()">
            <table class="airport-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Lote</th>
                        <th>Proceso</th>
                        <th>ANSI</th>
                        <th>Inspector</th>
                        <th>Resultado</th>
                        <th>Tiempo</th>
                        <th>Detalle</th>
                    </tr>
                </thead>
                <tbody id="hist-linea-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        let pausaSincro = false;
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbw_fVP141Zb2B1MBkJ1jbgtrGy95X9jxClsmAn3juYIC-pCjznEq2qaqxMLqvrbri8o/exec";
        const lineasArr = ["SOFIA 6F L1", "SOFIA 6F L2 / 5F L2", "SOFIA 6F L3 / EX", "SOFIA 5F / SOFIA 6F L2", "VIA / HW 27", "SCEPTER", "HW LONG", "HW SHORT / REGULAR L2", "HW 21 +", "HW REGULAR"];

        let catalogoDefectos = JSON.parse(localStorage.getItem('qc_catalogo_v2')) || {};
        let estados = [];
        let dbHistorial = [];
        let indexSel = null;
        let adminEditTemp = { idx: null, valor: null };

        function guardarCatalogo() {
            localStorage.setItem('qc_catalogo_v2', JSON.stringify(catalogoDefectos));
            const payload = { action: 'save_config', datos: catalogoDefectos };
            fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        }

      function inicializarSistema() {
    const sesion = localStorage.getItem('qc_session');
    if (sesion) {
        const data = JSON.parse(sesion);
        document.getElementById('user-display').innerText = `üë§ ${data.name}`;
        document.getElementById('r-inspector').value = data.name.toUpperCase();
        if (data.isAdmin) document.getElementById('btn-admin-access').style.display = 'inline-block';
    }

    // REGLA DE ORO: Agregamos loteAnterior para que la sincronizaci√≥n sea estable
    estados = lineasArr.map(nom => ({ 
        activo: false, 
        lote: '', 
        loteAnterior: '', // <--- ¬°AQU√ç EST√Å EL CAMBIO!
        inspector: '', 
        inicio: null, 
        horaInicioReal: '', 
        tiempo: '00:00', 
        productoActivo: nom.split(" / ")[0].trim(), 
        productoOriginal: nom, 
        proceso: 'Final', 
        ansi: 'Normal' 
    }));

    const selL = document.getElementById('r-linea');
    if (selL) selL.innerHTML = lineasArr.map((n, i) => `<option value="${i}">${n}</option>`).join('');

    cargarHistorialNube();
    render();
    setInterval(tick, 1000);
    setInterval(sincronizarConNube, 10000);
}

        async function cargarHistorialNube() {
            try {
                const res = await fetch(SHEETS_URL);
                const datos = await res.json();
                dbHistorial = datos.historial || [];
                render();
            } catch (e) { console.error("Error historial", e); }
        }

    function render() {
    const p = document.getElementById('pizarra');
    if (!p) return;

    p.innerHTML = estados.map((s, i) => {
        const turnos = obtenerConteosTurnos(lineasArr[i]);
        const tituloCard = s.activo ? s.productoActivo : lineasArr[i];
        
        return `
        <div class="card ${s.activo ? 'inspeccionando' : ''}">
            <div class="card-header">${tituloCard}</div>
            
            <div style="display: flex; background: #f8f9fa; font-size: 0.8em; padding: 5px; border-bottom: 1px solid #eee;">
                <div style="flex:1; text-align:center;">A: ${turnos.ta}</div>
                <div style="flex:1; text-align:center;">B: ${turnos.tb}</div>
            </div>

            <div class="card-body" style="min-height: 120px; display: flex; flex-direction: column; justify-content: center;">
                ${s.activo ? `
                    <div>üë§ ${s.inspector}</div>
                    <div class="lote-destacado">${s.lote}</div>
                    <div class="badge-info">
                        <span>${s.proceso}</span> ‚Ä¢ <span>${s.ansi}</span>
                    </div>
                   <div class="timer-display" id="t-${i}">${document.getElementById(`t-${i}`) ? document.getElementById(`t-${i}`).innerText : s.tiempo}</div>
                ` : `
                    <div style="text-align: center; color: #ccc; font-weight: bold; font-size: 1.2em; letter-spacing: 2px; padding: 20px 0;">
                        DISPONIBLE
                    </div>
                `}
            </div>

            <div class="card-footer">
                ${s.activo ? 
                    `<button class="btn-card btn-terminar" onclick="prepararFin(${i})">TERMINAR</button>` : 
                    `<button class="btn-card btn-historial" onclick="abrirHistorialIndividual(${i})">HISTORIAL</button>`
                }
            </div>
        </div>`;
    }).join('');

    localStorage.setItem('qc_v13_respaldo', JSON.stringify(estados));
}

        function obtenerConteosTurnos(nombreLinea) {
    let conteo = { ta: 0, tb: 0 };
    const hoy = new Date().toLocaleDateString();
    
    dbHistorial.forEach(r => {
        if (r.linea === nombreLinea && r.fecha === hoy) {
            // 1. Extraemos hora y minutos
            const partes = r.hora ? r.hora.split(':') : ["0", "0"];
            const hrs = parseInt(partes[0]);
            const mins = parseInt(partes[1]);
            
            // 2. Convertimos todo a "minutos del d√≠a" para comparar exacto
            const minutosTotales = (hrs * 60) + mins;
            
            // 3. El corte es a las 15:30 (que son 930 minutos)
            // Turno A: de 06:00 (360 min) hasta las 15:29 (929 min)
            if (minutosTotales >= 360 && minutosTotales < 930) {
                conteo.ta++;
            } else {
                conteo.tb++;
            }
        }
    });
    return conteo;
}

        function tick() {
            estados.forEach((s, i) => {
                if (s.activo) {
                    const d = Math.floor((Date.now() - s.inicio) / 1000);
                    s.tiempo = `${Math.floor(d / 60).toString().padStart(2, '0')}:${(d % 60).toString().padStart(2, '0')}`;
                    const el = document.getElementById(`t-${i}`);
                    if (el) el.innerText = s.tiempo;
                }
            });
            document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
        }

        function abrirModal(id) {
            document.getElementById(id).style.display = 'block';
            pausaSincro = true;
            if (id === 'modal-reg') verificarHibrida();
        }

        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
            pausaSincro = false;
        }

async function iniciarLote() {
    const inputLote = document.getElementById('r-lote');
    if (!inputLote.value.trim()) return alert("‚ö†Ô∏è Ingrese el n√∫mero de Lote");
    
    // üõ°Ô∏è BLOQUEO: Evita interferencias de la nube mientras registramos
    pausaSincro = true; 
    
    const idx = document.getElementById('r-linea').value;
    const btn = document.querySelector("#modal-reg .btn-main");
    
    btn.disabled = true;
    btn.innerText = "‚è≥ REGISTRANDO...";

    const ahora = new Date();
    
    const datosInicio = {
        activo: true,
        lote: inputLote.value.trim(),
        inicio: ahora.getTime(), 
        horaInicioReal: `${ahora.getHours().toString().padStart(2, '0')}:${ahora.getMinutes().toString().padStart(2, '0')}`,
        inspector: document.getElementById('r-inspector').value,
        proceso: document.getElementById('r-proceso').value,
        ansi: document.getElementById('r-ansi').value,
        productoActivo: (document.getElementById('contenedor-hibrida').style.display === 'block') ? document.getElementById('r-producto-especifico').value : lineasArr[idx]
    };

    // Actualizaci√≥n visual inmediata
    estados[idx] = datosInicio; 
    render();                   
    cerrarModal('modal-reg');  

    try {
        // --- CAMBIO CLAVE AQU√ç ---
        await fetch(SHEETS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: {
                'Content-Type': 'text/plain' // Esto evita errores de CORS en Google
            },
            body: JSON.stringify({ 
                action: 'save_pizarra', 
                estados: estados 
            }) 
        });
        console.log("‚úÖ Datos sincronizados con la nube.");
    } catch (e) {
        console.warn("‚ö†Ô∏è Error de red, el lote se guard√≥ solo localmente.");
    } finally {
        // Restaurar bot√≥n
        btn.disabled = false;
        btn.innerText = "INICIAR INSPECCI√ìN";
        inputLote.value = ""; 
        
        // Mantener el escudo de sincronizaci√≥n por 10 seg para evitar "saltos" de datos
        setTimeout(() => { 
            pausaSincro = false; 
            console.log("üõ°Ô∏è Escudo liberado.");
        }, 10000); 
    }
}
async function finalizarLote(ok) {
    const s = estados[indexSel];
    if (!s || !s.activo) return;

    // 1. BLOQUEO VISUAL Y DE SYNC
    const btn = document.querySelector(ok ? "#modal-fin .btn-main" : "#modal-rechazos .btn-main");
    if(btn) {
        btn.disabled = true;
        btn.innerText = "‚åõ GUARDANDO...";
    }
    
    pausaSincro = true; 

    const ahora = new Date();
    
    // --- MEJORA: Formateo de Fecha Manual para evitar errores de zona horaria ---
    const dia = ahora.getDate().toString().padStart(2, '0');
    const mes = (ahora.getMonth() + 1).toString().padStart(2, '0');
    const anio = ahora.getFullYear();
    const fechaLimpia = `${dia}/${mes}/${anio}`;

    const horaFin = ahora.getHours().toString().padStart(2, '0') + ':' + 
                    ahora.getMinutes().toString().padStart(2, '0');

    // Construimos el registro para el Historial
    const registro = {
        action: 'add', 
        fecha: fechaLimpia,  // Enviamos la fecha ya formateada como texto
        horaFin: horaFin,    // HH:mm
        hora: s.horaInicioReal,
        linea: lineasArr[indexSel], 
        producto: s.productoActivo, 
        inspector: s.inspector,
        lote: s.lote,        // El ap√≥strofe lo pondremos en el Apps Script para mayor seguridad
        proceso: s.proceso, 
        ansi: s.ansi, 
        tiempo: String(s.tiempo), // Forzamos a String aqu√≠ tambi√©n
        resultado: ok ? "ACEPTADO" : "RECHAZADO", 
        detalle: ok ? "OK" : Array.from(document.querySelectorAll('.m-rechazo')).map(sel => sel.value).join(", ")
    };

    // --- LIMPIEZA LOCAL PROFUNDA ---
    const loteFinalizado = s.lote;
    
    estados[indexSel] = {
        productoOriginal: s.productoOriginal, 
        activo: false,
        lote: "",
        loteAnterior: loteFinalizado,
        ultimoCierreReal: ahora.getTime(), 
        inspector: "",
        tiempo: "00:00",
        productoActivo: "",
        proceso: "",
        ansi: ""
    };
    
    render(); 
    cerrarModal(ok ? 'modal-fin' : 'modal-rechazos');

    // 2. ENV√çO COORDINADO
    try {
        console.log("üì§ Enviando historial...");
        await fetch(SHEETS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(registro) 
        });

        console.log("üì§ Limpiando pizarra en la nube...");
        await fetch(SHEETS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({ 
                action: 'save_pizarra', 
                estados: estados 
            }) 
        });
        
        console.log("‚úÖ Proceso completado con √©xito.");
    } catch (e) {
        console.error("‚ùå Error de comunicaci√≥n:", e);
    } finally {
        setTimeout(() => { 
            pausaSincro = false; 
            if(btn) {
                btn.disabled = false;
                btn.innerText = ok ? "ACEPTAR" : "CONFIRMAR RECHAZO";
            }
            console.log("üõ°Ô∏è Escudo liberado.");
        }, 15000); 
    }
}
   function verificarHibrida() {
    const idx = document.getElementById('r-linea').value;
    const nom = lineasArr[idx];
    const cont = document.getElementById('contenedor-hibrida');
    const selProceso = document.getElementById('r-proceso');
    const selAnsi = document.getElementById('r-ansi');

    // 1. L√≥gica de productos h√≠bridos (tu c√≥digo actual)
    if (nom.includes(" / ")) {
        document.getElementById('r-producto-especifico').innerHTML = nom.split(" / ").map(p => `<option value="${p.trim()}">${p.trim()}</option>`).join('');
        cont.style.display = 'block';
    } else {
        cont.style.display = 'none';
    }

    // 2. L√≥gica de procesos (tu c√≥digo actual)
    let opciones = `<option value="Shaft">Shaft</option><option value="Final">Final</option><option value="HubBonding">Hub Bonding</option><option value="Pre-Empaque">Pre-Empaque</option>`;
    if (nom.toUpperCase().includes("SCEPTER")) opciones += `<option value="Guidewire">Guidewire</option>`;
    selProceso.innerHTML = opciones;

    // --- NUEVO: L√≥gica para ocultar ANSI si es Pre-Empaque ---
    // Agregamos un listener para cuando cambien el proceso manualmente
    selProceso.onchange = function() {
        if (this.value === "Pre-Empaque") {
            selAnsi.style.display = "none";
            // Opcional: podr√≠as poner una etiqueta que diga "No aplica"
        } else {
            selAnsi.style.display = "block";
        }
    };
    
    // Ejecutar una vez al abrir para resetear el estado
    selAnsi.style.display = (selProceso.value === "Pre-Empaque") ? "none" : "block";
// L√≥gica para ocultar ANSI si es Pre-Empaque
    selProceso.onchange = function() {
        if (this.value === "Pre-Empaque") {
            selAnsi.style.display = "none";
        } else {
            selAnsi.style.display = "block";
        }
    };
    
    // Resetear el estado al abrir el modal
    selAnsi.style.display = (selProceso.value === "Pre-Empaque") ? "none" : "block";
}

async function sincronizarConNube() {
    // 1. No sincronizar si estamos operando o hay un modal abierto
    if (pausaSincro || document.querySelector('.modal[style*="block"]')) return;

    try {
        const res = await fetch(SHEETS_URL);
        const data = await res.json();
        
        if (data.historial) {
            dbHistorial = data.historial;
        }

        if (data.pizarra) {
            let huboCambio = false;
            const ahora = new Date().getTime();

            data.pizarra.forEach((nube, i) => {
                if (!estados[i]) {
                    estados[i] = { activo: false, lote: "" };
                }
                
                const local = estados[i];

                // --- PROTECCI√ìN ACTUALIZADA ---
                // Si la nube dice que est√° vac√≠o (activo: false)
                if (!nube.activo && local.activo) {
                    // Solo mantenemos el bloqueo si el lote local es "joven" (menos de 30 seg)
                    // Esto da tiempo a que el servidor procese tu propio env√≠o.
                    // Pero si ya pas√≥ ese tiempo, aceptamos que la nube manda (el lote termin√≥).
                    const tiempoTranscurrido = ahora - (local.ultimoCierreReal || 0);
                    if (pausaSincro && tiempoTranscurrido < 15000) return; 
                }

                // --- DETECTAR CAMBIOS REALES ---
                // Si el lote cambi√≥, o el estado activo/inactivo cambi√≥
                if (nube.lote !== local.lote || nube.activo !== local.activo) {
                    // Si se desactiv√≥ en la nube, guardamos rastro para el render
                    if (local.activo && !nube.activo) {
                        nube.loteAnterior = local.lote;
                    }
                    
                    estados[i] = nube;
                    huboCambio = true;
                    return;
                }

                // --- COMPARACI√ìN POR DETALLES ---
                if (JSON.stringify(local) !== JSON.stringify(nube)) {
                    estados[i] = nube;
                    huboCambio = true;
                }
            });
            
            if (huboCambio) {
                console.log("üì° Pizarra sincronizada con el servidor");
                render();
            }
        }
    } catch (e) { 
        console.error("‚ùå Error Sync:", e); 
    }
}
        function mostrarTab(t) {
            ['sec-yield', 'sec-gestion', 'sec-defectos'].forEach(id => document.getElementById(id).style.display = id.includes(t) ? 'block' : 'none');
            if (t === 'defectos') inicializarSelectoresAdmin();
            if (t === 'yield') generarReporteYield();
            if (t === 'gestion') generarGestionLotes();
        }

        function inicializarSelectoresAdmin() {
            document.getElementById('admin-def-linea').innerHTML = lineasArr.map(n => `<option value="${n}">${n}</option>`).join('');
            renderizarListaDefectosAdmin();
        }

        function renderizarListaDefectosAdmin() {
            const l = document.getElementById('admin-def-linea').value;
            const p = document.getElementById('admin-def-proceso').value;
           const lista = (catalogoDefectos[l] && catalogoDefectos[l][p]) ? catalogoDefectos[l][p] : [];
            document.getElementById('lista-defectos-configurados-tabla').innerHTML = lista.map((d, i) => `<tr><td>${d}</td><td><button onclick="eliminarDefecto('${l}','${p}',${i})">üóëÔ∏è</button></td></tr>`).join('');
        }

        function agregarDefectoNuevo() {
            const l = document.getElementById('admin-def-linea').value;
            const p = document.getElementById('admin-def-proceso').value;
            const v = document.getElementById('admin-def-nombre').value.trim();
            if (!v) return;
            if (!catalogoDefectos[l]) catalogoDefectos[l] = {};
            if (!catalogoDefectos[l][p]) catalogoDefectos[l][p] = [];
            catalogoDefectos[l][p].push(v);
            guardarCatalogo();
            document.getElementById('admin-def-nombre').value = "";
            renderizarListaDefectosAdmin();
        }

        function eliminarDefecto(l, p, i) {
            catalogoDefectos[l][p].splice(i, 1);
            guardarCatalogo();
            renderizarListaDefectosAdmin();
        }

      // Agregamos (datos) para que la funci√≥n sea flexible
function generarReporteYield(datos = dbHistorial) {
    const stats = {};
    
    // Usamos "datos" (que pueden ser los de hoy o todos)
    datos.forEach(r => {
        const ins = r.inspector || "N/A";
        if (!stats[ins]) stats[ins] = { ok: 0, fail: 0, total: 0 };
        stats[ins].total++;
        if (r.resultado === 'ACEPTADO') stats[ins].ok++; else stats[ins].fail++;
    });

    document.getElementById('yield-table-body').innerHTML = Object.keys(stats).map(k => {
        const d = stats[k];
        const y = d.total > 0 ? ((d.ok / d.total) * 100).toFixed(1) : "0.0";
        return `<tr><td>${k}</td><td>${d.ok}</td><td>${d.fail}</td><td>${d.total}</td><td>${y}%</td></tr>`;
    }).join('');
}
function filtrarPorFecha(rango) {
    const hoy = new Date().toLocaleDateString();
    const spanRango = document.getElementById('rango-actual');
    
    let filtrados;
    if (rango === 'hoy') {
        filtrados = dbHistorial.filter(r => r.fecha === hoy);
        if (spanRango) spanRango.innerText = "üìç Viendo: Hoy";
    } else {
        filtrados = dbHistorial;
        if (spanRango) spanRango.innerText = "üìç Viendo: Todo";
    }

    // Le enviamos los datos filtrados a la funci√≥n que dibuja la tabla
    generarReporteYield(filtrados);
}
        function generarGestionLotes() {
            const tbody = document.getElementById('gestion-table-body');
            tbody.innerHTML = [...dbHistorial].reverse().slice(0, 50).map((r, i) => `
                <tr>
                    <td>${r.lote}</td>
                    <td>${r.proceso}</td>
                    <td>${r.ansi}</td>
                    <td>${r.resultado}</td>
                    <td>${r.detalle}</td>
                    <td><button onclick="borrarRegistro(${dbHistorial.length - 1 - i})">üóëÔ∏è</button></td>
                </tr>`).join('');
        }

        async function borrarRegistro(idx) {
            if (!confirm("¬øEliminar registro?")) return;
            const r = dbHistorial[idx];
            fetch(SHEETS_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', lote: r.lote, fecha: r.fecha, hora: r.hora }) });
            dbHistorial.splice(idx, 1);
            generarGestionLotes();
        }

        function prepararFin(i) {
            indexSel = i;
            const sesion = JSON.parse(localStorage.getItem('qc_session'));
            if (estados[i].inspector.includes(sesion.name.toUpperCase()) || sesion.isAdmin) {
                abrirModal('modal-fin');
            } else alert("Solo el responsable puede finalizar.");
        }

        function abrirRechazos() { cerrarModal('modal-fin'); abrirModal('modal-rechazos'); generarDefectos(); }
function exportarExcelGeneral() {
    // 1. Agregamos "Hora Fin" en los encabezados despu√©s de "Hora"
    let csv = "\uFEFFsep=;\nFecha;Hora Inicio;Hora Fin;Linea;Producto;Inspector;Lote;Proceso;ANSI;Resultado;Tiempo;Detalle\n";
    
    dbHistorial.forEach(r => {
        // 2. Insertamos r.horaFin en la cadena de datos
        // Usamos (r.horaFin || "--:--") para que los registros viejos no salgan vac√≠os
        csv += `${r.fecha};${r.hora};${r.horaFin || '--:--'};${r.linea};${r.producto};${r.inspector};${r.lote};${r.proceso};${r.ansi};${r.resultado};${r.tiempo};${r.detalle}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Reporte_QC_Final.csv";
    link.click();
}
        function abrirAdmin() { abrirModal('modal-admin'); mostrarTab('yield'); }
        
        function abrirHistorialIndividual(idx) {
    const nom = lineasArr[idx];
    document.getElementById('hist-linea-titulo').innerText = "Historial: " + nom;
    const filtrados = dbHistorial.filter(r => r.linea === nom).reverse();
    
    document.getElementById('hist-linea-body').innerHTML = filtrados.map(r => `
        <tr>
            <td style="line-height: 1.2; min-width: 90px;">
                ${r.fecha} <br> 
                <span style="font-size: 0.85em; color: #555; font-weight: bold;">
                     Fin: ${r.horaFin || '--:--'}
                </span>
            </td>
            <td>${r.lote}</td>
            <td>${r.proceso}</td>
            <td>${r.ansi}</td>
            <td>${r.inspector}</td>
            <td style="font-weight: bold; color: ${r.resultado === 'ACEPTADO' ? '#28a745' : '#dc3545'};">
                ${r.resultado}
            </td>
            <td>${r.tiempo}</td>
            <td>${r.detalle}</td>
        </tr>`).join('');
        
    abrirModal('modal-historial-linea');
}
function exportarHistorialIndividual() {
    // 1. Obtenemos el nombre de la l√≠nea desde el t√≠tulo del modal
    const titulo = document.getElementById('hist-linea-titulo').innerText;
    const nombreLinea = titulo.replace("Historial: ", "").trim();

    // 2. Filtramos los datos de dbHistorial igual que lo hace la tabla
    const filtrados = dbHistorial.filter(r => r.linea === nombreLinea).reverse();

    if (filtrados.length === 0) {
        alert("No hay datos para exportar");
        return;
    }

    // 3. Creamos el CSV con el mismo orden que tu Excel General, incluyendo Hora Fin
    let csv = "\uFEFFsep=;\nFecha;Hora Inicio;Hora Fin;Linea;Producto;Inspector;Lote;Proceso;ANSI;Resultado;Tiempo;Detalle\n";

    filtrados.forEach(r => {
        // Usamos punto y coma para que Excel lo abra correctamente
       csv += `${r.fecha};${r.hora || '--:--'};${r.horaFin || '--:--'};${r.linea};${r.producto || ''};${r.inspector};${r.lote};${r.proceso};${r.ansi};${r.resultado};${r.tiempo};${r.detalle}\n`;
    });

    // 4. Descarga del archivo
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Historial_${nombreLinea}.csv`;
    link.click();
}
async function guardarEstadoPizarraEnNube() {
    try {
        const sesion = JSON.parse(localStorage.getItem('qc_session'));
        const payload = { 
            action: 'save_pizarra', 
            estados: estados, 
            lastUpdateBy: sesion?.name || "Sistema" 
        };
        
        console.log("Sincronizando pizarra con la nube...");
        
        // Eliminamos el 'return await' y usamos una promesa limpia
        // El secreto es usar 'text/plain' para que Google no bloquee por seguridad (CORS)
        return fetch(SHEETS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: {
                'Content-Type': 'text/plain' // Cambiamos esto para evitar el error rojo de CORS
            },
            body: JSON.stringify(payload) 
        });
    } catch (error) {
        console.error("Error cr√≠tico en guardarEstadoPizarraEnNube:", error);
    }
}
function filtrarLotesAdmin() {
    const busqueda = document.getElementById('input-busqueda').value.toLowerCase();
    const filas = document.querySelectorAll('#gestion-table-body tr');

    filas.forEach(fila => {
        // Obtenemos el texto de la primera celda (Lote)
        const textoLote = fila.cells[0].textContent.toLowerCase();
        
        if (textoLote.includes(busqueda)) {
            fila.style.display = "";
        } else {
            fila.style.display = "none";
        }
    });
}   
function filtrarLoteHistorialIndividual() {
    const busqueda = document.getElementById('busqueda-lote-historial').value.toLowerCase();
    const filas = document.querySelectorAll('#hist-linea-body tr');

    filas.forEach(fila => {
        // Buscamos en la celda del Lote (columna 1)
        const textoLote = fila.cells[1].textContent.toLowerCase();
        
        if (textoLote.includes(busqueda)) {
            fila.style.display = "";
        } else {
            fila.style.display = "none";
        }
    });
// Filtro para la pesta√±a de Administraci√≥n
// --- FUNCIONES DE FILTRO ---

// --- SUSTITUYE DESDE AQU√ç HACIA ABAJO ---

// Filtro para la pesta√±a de Administraci√≥n
function filtrarLotesAdmin() {
    const busqueda = document.getElementById('input-busqueda').value.toLowerCase();
    const filas = document.querySelectorAll('#gestion-table-body tr');

    filas.forEach(fila => {
        const textoLote = fila.cells[0].textContent.toLowerCase();
        fila.style.display = textoLote.includes(busqueda) ? "" : "none";
    });
}

// Filtro para el Historial de cada l√≠nea
function filtrarLoteHistorialIndividual() {
    const input = document.getElementById('busqueda-lote-historial');
    if (!input) return;
    const busqueda = input.value.toLowerCase();
    const filas = document.querySelectorAll('#hist-linea-body tr');

    filas.forEach(fila => {
        const textoLote = fila.cells[1].textContent.toLowerCase();
        fila.style.display = textoLote.includes(busqueda) ? "" : "none";
    });
}

// Funci√≥n para los botones de "Hoy" y "Todo"
function filtrarPorFecha(rango) {
    const hoy = new Date().toLocaleDateString('es-ES');
    const spanRango = document.getElementById('rango-actual');
    
    let filtrados = (rango === 'hoy') ? dbHistorial.filter(r => r.fecha === hoy) : dbHistorial;
    
    if (spanRango) spanRango.innerText = (rango === 'hoy') ? "üìç Viendo: Hoy" : "üìç Viendo: Todo";

    generarReporteYield(filtrados);
}
}

// Cierre definitivo del script y del HTML
</script>
</body>
</html>