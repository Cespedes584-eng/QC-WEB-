<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Tracker</title>
    <style>
        :root {
            /* Paleta unificada con el Dashboard */
            --bg-body: #ebedef; 
            --panel-bg: #ffffff; 
            --primary-dark: #24303c;    /* Azul oscuro del Dashboard */
            --primary-green: #468e5d;   /* Verde institucional */
            --alert-red: #da3633; 
            --text-dark: #333333; 
            --border: #d1d8d5;
        }
        
        body { background-color: var(--bg-body); color: var(--text-dark); font-family: 'Segoe UI', sans-serif; margin: 0; }
        
        /* Header ajustado al estilo oscuro del Dashboard */
        .header { 
            background: var(--primary-dark); 
            padding: 12px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--primary-green); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
            color: white;
        }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; padding: 20px; }
        
        /* Tarjetas con sombras m√°s suaves */
        .card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; min-height: 320px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; }
        .card.inspeccionando { border: 2px solid var(--primary-green); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        
        /* Encabezados de tarjetas con el verde del logo */
        .card-header { background: var(--primary-green); padding: 12px; font-weight: bold; text-align: center; color: white; text-transform: uppercase; letter-spacing: 1px; }
        
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .lote-destacado { font-size: 1.4em; font-weight: 800; margin: 5px 0; color: var(--primary-dark); }
        
        .badge-info { font-size: 0.75em; margin-bottom: 8px; color: var(--primary-green); }
        .badge-info span { background: #f0f4f1; padding: 2px 6px; border-radius: 4px; border: 1px solid #d1d8d5; }
        
        .timer-display { font-family: monospace; font-size: 1.7em; color: var(--primary-green); font-weight: bold; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        .btn-card { border: none; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-terminar { background: #546e7a; color: #fff; }
        .btn-terminar:hover { background: #37474f; }
        .btn-historial { background: #ffffff; color: var(--primary-green); border-top: 1px solid #eee; }
        .btn-historial:hover { background: #f9f9f9; }
        
        /* Botones principales */
        .btn-main { background: var(--primary-green); color: white; border: none; padding: 10px 18px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-main:hover { opacity: 0.9; }

        .modal, .airport-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 4000; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 25px; border-radius: 8px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .airport-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 10px; }
        .airport-table th { background: #f1f3f5; padding: 10px; border-bottom: 2px solid var(--primary-green); color: var(--primary-dark); }
        .airport-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        
        input, select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        
        /* Bot√≥n Flotante */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary-green); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: 0.3s; }
        .fab:hover { transform: scale(1.1); }

        .search-bar { background: #fff; border: 1px solid var(--border); padding: 12px; margin-bottom: 15px; font-size: 1em; border-radius: 4px; }
        
        /* Info de Usuario */
        .user-info { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); color: white; font-weight: bold; font-size: 0.9em; }
        
        .btn-excel-header { background: #27ae60; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85em; }
        
        /* Reloj estilo Dashboard */
        #reloj { font-family: monospace; font-size: 1.1em; background: rgba(0,0,0,0.3); color: #fff; padding: 4px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* Bot√≥n Volver estilo Dashboard */
        .btn-back { background: #455a64; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn-back:hover { background: #263238; }

        h3 { color: var(--primary-dark); border-bottom: 2px solid var(--primary-green); padding-bottom: 8px; }
    </style>
</head>
<body onload="inicializarSistema()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-back" onclick="location.href='index.html'">üè† VOLVER</button>
            <button id="btn-admin-access" class="btn-main" style="background:#5c6bc0; display: none;" onclick="abrirAdmin()">‚öôÔ∏è ADMIN</button>
            <span style="font-weight: 800; color: white; font-size: 1.2em; letter-spacing: 1px;">QC TRACKER V13.8</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="user-display" class="user-info">USUARIO</div>
            <button class="btn-excel-header" onclick="exportarExcelGeneral()">üìä EXCEL</button>
            <div id="reloj">00:00:00</div>
        </div>
    </div>

    <div id="pizarra" class="grid-container"></div>
    <div class="fab" onclick="abrirModal('modal-reg')">+</div>

    <div id="modal-admin" class="airport-modal">
        <div style="background: white; margin: 10px auto; width: 98%; max-width: 1150px; border-radius: 8px; padding: 25px; height: 90vh; overflow-y: auto; position: relative;">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-admin')">√ó</button>
            <h2 style="color:var(--primary-dark); margin-top:0;">Panel de Control Admin</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn-main" onclick="mostrarTab('yield')">üìä Rendimiento Yield</button>
                <button class="btn-main" onclick="mostrarTab('gestion')">‚öôÔ∏è Gesti√≥n de Datos</button>
            </div>
            
            <div id="sec-yield">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px;">
                    <input type="text" id="busqueda-inspector" class="search-bar" placeholder="üîç Buscar Inspector..." onkeyup="filtrarYield()" style="margin-bottom:0; flex-grow:1;">
                    <button class="btn-excel-header" onclick="exportarExcelYield()">üì• EXCEL RENDIMIENTO</button>
                </div>
                <table class="airport-table">
                    <thead><tr><th>Inspector</th><th>Aceptados</th><th>Rechazados</th><th>Total</th><th>Yield %</th></tr></thead>
                    <tbody id="yield-table-body"></tbody>
                </table>
            </div>

            <div id="sec-gestion" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; gap:10px;">
                    <input type="text" id="input-busqueda" class="search-bar" placeholder="üîç Buscar por Lote # ..." onkeyup="filtrarLotesAdmin()" style="margin-bottom:0; flex-grow:1;">
                    <button class="btn-excel-header" onclick="exportarExcelGestion()">üì• EXCEL GESTI√ìN</button>
                </div>
                <table class="airport-table">
                    <thead><tr><th>Lote</th><th>L√≠nea Base</th><th>Resultado</th><th>Detalle/Defectos</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="gestion-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-defecto-admin" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--alert-red); border-color: var(--alert-red);">Cambiar a Rechazado</h3>
            <label>Cantidad de Defectos:</label>
            <input type="number" id="rech-qty-admin" value="1" min="1" onchange="generarDefectosAdmin()">
            <div id="contenedor-defectos-admin" style="margin-bottom: 15px;"></div>
            <button class="btn-main" style="width:100%; background:var(--alert-red);" onclick="confirmarCambioRechazo()">ACTUALIZAR REGISTRO</button>
            <button class="btn-main" style="width:100%; background:#ccc; margin-top:10px; color:#333;" onclick="cerrarModal('modal-defecto-admin')">CANCELAR</button>
        </div>
    </div>

    <div id="modal-historial-linea" class="airport-modal">
        <div style="background: white; margin: 20px auto; width: 95%; max-width: 1000px; border-radius: 8px; padding: 25px; height: 80vh; overflow-y: auto; position: relative;">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-historial-linea')">√ó</button>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="hist-linea-titulo" style="margin:0;"></h3>
                <button id="btn-descarga-individual" class="btn-excel-header">üì• DESCARGAR HISTORIAL</button>
            </div>
            <input type="text" id="busqueda-lote-historial" class="search-bar" placeholder="üîç Filtrar por Lote #..." onkeyup="filtrarLoteHistorialIndividual()">
            <table class="airport-table">
                <thead><tr><th>Fecha</th><th>Hora Inicio</th><th>Lote</th><th>Inspector</th><th>Resultado</th><th>Duraci√≥n</th><th>Defecto</th></tr></thead>
                <tbody id="hist-linea-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-reg" class="modal">
        <div class="modal-content">
            <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-reg')">√ó</button>
            <h3>Nueva Inspecci√≥n</h3>
            <label>L√≠nea</label>
            <select id="r-linea" onchange="verificarHibrida()"></select>
            <div id="contenedor-hibrida" style="display:none; background: #f0f4f1; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid var(--border);">
                <label><b>Producto Espec√≠fico:</b></label>
                <select id="r-producto-especifico"></select>
            </div>
            <input type="text" id="r-lote" placeholder="Lote #">
            <input type="text" id="r-inspector" readonly style="background:#f1f1f1; cursor: not-allowed;">
            <select id="r-proceso"><option>Shaft</option><option>Final</option><option>Hub Bonding</option></select>
            <select id="r-ansi"><option>Normal</option><option>Reducido</option><option>Riguroso</option></select>
            <button class="btn-main" style="width:100%;" onclick="iniciarLote()">INICIAR INSPECCI√ìN</button>
        </div>
    </div>

    <div id="modal-fin" class="modal"><div class="modal-content"><h3>¬øLote Aceptado?</h3><button class="btn-main" style="width:100%;" onclick="finalizarLote(true)">ACEPTAR</button><button class="btn-main" style="background:var(--alert-red); width:100%; margin-top:10px;" onclick="abrirRechazos()">RECHAZAR</button></div></div>
    <div id="modal-rechazos" class="modal"><div class="modal-content"><h3>Defectos Detectados</h3><input type="number" id="rech-qty" value="1" onchange="generarDefectos()"><div id="contenedor-defectos"></div><button class="btn-main" style="background:var(--alert-red); width:100%;" onclick="finalizarLote(false)">GUARDAR RECHAZO</button></div></div>

    <script>

    // Variable para que no se crucen los datos mientras escribes
    let pausaSincro = false;

    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbw_s-tC7AxsQpSMeM2Rv2C4BCTTBE0r6xAy_CL2DxdZqNHwBT6VTM2n-JuHgiCglVTd/exec";
    const lineasArr = ["SOFIA 6F L1", "SOFIA 6F L2 / 5F L2", "SOFIA 6F L3 / EX", "SOFIA 5F / SOFIA 6F L2", "VIA / HW 27", "SCEPTER", "HW LONG", "HW SHORT / REGULAR L2", "HW 21 +", "HW REGULAR"];
    const defectosLista = ["Visual", "Derrame", "Medida", "Empaque"];
    let estados = []; let dbHistorial = []; let indexSel = null; let adminEditTemp = { idx: null, valor: null };

    function inicializarSistema() {
        const sesion = localStorage.getItem('qc_session');
        if(sesion) {
            const data = JSON.parse(sesion);
            document.getElementById('user-display').innerText = `üë§ ${data.name.toUpperCase()} (ID: ${data.id})`;
            document.getElementById('r-inspector').value = data.name.toUpperCase();
            if(data.isAdmin) {
                document.getElementById('btn-admin-access').style.display = 'inline-block';
            }
        }
        const local = localStorage.getItem('qc_v13_respaldo');
        estados = local ? JSON.parse(local) : lineasArr.map(nom => ({ 
            activo: false, lote: '', inspector: '', inicio: null, horaInicioReal: '', tiempo: '00:00', 
            productoActivo: nom.split(" / ")[0].trim(), productoOriginal: nom, proceso: 'Final', ansi: 'Normal' 
        }));
        const selL = document.getElementById('r-linea');
        lineasArr.forEach((n, i) => { selL.innerHTML += `<option value="${i}">${n}</option>`; });
        cargarHistorialNube(); 
        render(); 
        setInterval(tick, 1000);
        sincronizarConNube(); 
        setInterval(sincronizarConNube, 7000); 
    }

    async function cargarHistorialNube() {
        try { const res = await fetch(SHEETS_URL); const datos = await res.json(); dbHistorial = datos.historial || []; } catch(e) { console.error("Error conexi√≥n"); }
    }

    function formatearTexto(valor) {
        if (!valor) return "";
        let str = String(valor);
        if (str.includes("T")) {
            let partes = str.split("T");
            return partes[1] ? partes[1].substring(0, 8) : partes[0];
        }
        return str;
    }

    function render() {
        const p = document.getElementById('pizarra');
        p.innerHTML = estados.map((s, i) => `
            <div class="card ${s.activo ? 'inspeccionando' : ''}">
                <div class="card-header">${s.productoActivo}</div>
                <div class="card-body">
                    ${s.activo ? `<div>üë§ ${s.inspector}</div><div class="lote-destacado">${s.lote}</div><div class="badge-info"><span>${s.proceso}</span> ‚Ä¢ <span>${s.ansi}</span></div><div class="timer-display" id="t-${i}">${s.tiempo}</div>` : '<div style="opacity:0.3; font-weight:bold;">DISPONIBLE</div>'}
                </div>
                ${s.activo ? `<button class="btn-card btn-terminar" onclick="prepararFin(${i})">TERMINAR</button>` : `<button class="btn-card btn-historial" onclick="abrirHistorialIndividual(${i})">HISTORIAL</button>`}
            </div>`).join('');
        
        localStorage.setItem('qc_v13_respaldo', JSON.stringify(estados));
        if (!pausaSincro) guardarEstadoPizarraEnNube();
    }

    function abrirHistorialIndividual(idx) {
        const nom = lineasArr[idx];
        document.getElementById('hist-linea-titulo').innerText = "Historial: " + nom;
        document.getElementById('busqueda-lote-historial').value = "";
        const filtrados = dbHistorial.filter(r => r.linea === nom).reverse();
        document.getElementById('hist-linea-body').innerHTML = filtrados.map(r => `
            <tr>
                <td>${formatearTexto(r.fecha)}</td>
                <td>${formatearTexto(r.hora)}</td>
                <td><b>${r.lote}</b></td>
                <td>${r.inspector}</td>
                <td style="color:${r.resultado==='ACEPTADO'?'green':'red'}; font-weight:bold;">${r.resultado}</td>
                <td>${r.tiempo}</td>
                <td>${r.detalle}</td>
            </tr>`).join('');
        document.getElementById('btn-descarga-individual').onclick = () => exportarExcel(filtrados, `Historial_${nom.replace(/ /g, "_")}`);
        abrirModal('modal-historial-linea');
    }

    function filtrarLoteHistorialIndividual() {
        const query = document.getElementById('busqueda-lote-historial').value.toLowerCase();
        const filas = document.querySelectorAll('#hist-linea-body tr');
        filas.forEach(f => { f.style.display = f.cells[2].innerText.toLowerCase().includes(query) ? "" : "none"; });
    }

    function abrirAdmin() { abrirModal('modal-admin'); cargarHistorialNube().then(() => { generarReporteYield(); generarGestionLotes(); }); }
    
   function generarGestionLotes() {
    const ultimos = [...dbHistorial].reverse();
    document.getElementById('gestion-table-body').innerHTML = ultimos.map((r, i) => {
        const realIdx = dbHistorial.length - 1 - i;
        // Esta es la parte pesada: crear los selectores de edici√≥n para cada fila
        return `<tr>
            <td><b>${r.lote}</b></td>
            <td>
                <select onchange="adminModificar(${realIdx}, 'linea', this.value)">
                    ${lineasArr.map(l => `<option ${r.linea===l?'selected':''}>${l}</option>`).join('')}
                </select>
            </td>
            <td>
                <select onchange="adminModificar(${realIdx}, 'resultado', this.value)" 
                        style="color:${r.resultado==='ACEPTADO'?'green':'red'}; font-weight:bold;">
                    <option value="ACEPTADO" ${r.resultado==='ACEPTADO'?'selected':''}>ACEPTADO</option>
                    <option value="RECHAZADO" ${r.resultado==='RECHAZADO'?'selected':''}>RECHAZADO</option>
                </select>
            </td>
            <td><input type="text" value="${r.detalle}" onchange="adminModificar(${realIdx}, 'detalle', this.value)" style="width:90%"></td>
            <td><button onclick="borrarRegistro(${realIdx})" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button></td>
        </tr>`;
    }).join('');
}

    function adminModificar(idx, campo, valor) {
        if (campo === 'resultado' && valor === 'RECHAZADO') {
            adminEditTemp = { idx, valor };
            document.getElementById('rech-qty-admin').value = 1;
            generarDefectosAdmin();
            abrirModal('modal-defecto-admin');
        } else {
            dbHistorial[idx][campo] = valor;
            if (campo === 'resultado' && valor === 'ACEPTADO') dbHistorial[idx].detalle = "OK";
            ejecutarSync(dbHistorial[idx]);
        }
    }

    function confirmarCambioRechazo() {
        const r = dbHistorial[adminEditTemp.idx];
        const defectos = Array.from(document.querySelectorAll('.m-rechazo-admin')).map(sel => sel.value).join(", ");
        r.resultado = 'RECHAZADO';
        r.detalle = defectos;
        ejecutarSync(r);
        cerrarModal('modal-defecto-admin');
    }

    function ejecutarSync(registro) {
        fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'edit', ...registro }) });
        generarReporteYield(); generarGestionLotes();
    }
function borrarRegistro(idx) {
    if (!confirm("¬øEst√°s seguro de que deseas eliminar este registro? Esta acci√≥n no se puede deshacer en la base de datos.")) return;

    const registroABorrar = dbHistorial[idx];
    
    // Enviamos la instrucci√≥n de borrado a Google Sheets
    fetch(SHEETS_URL, { 
        method: 'POST', 
        mode: 'no-cors', 
        body: JSON.stringify({ 
            action: 'delete', 
            lote: registroABorrar.lote,
            fecha: registroABorrar.fecha,
            hora: registroABorrar.hora 
        }) 
    });

    // Lo eliminamos visualmente de inmediato
    dbHistorial.splice(idx, 1);
    generarGestionLotes();
    generarReporteYield();
    alert("Registro eliminado localmente. La nube se actualizar√° en breve.");
}

    function iniciarLote() {
        const inputLote = document.getElementById('r-lote');
        const lVal = inputLote.value.trim();
        if(!lVal) return alert("Ingrese Lote");
        const idx = document.getElementById('r-linea').value;
        const s = estados[idx];
        const ahora = new Date();
        s.activo = true; 
        s.lote = lVal; 
        s.inicio = ahora.getTime(); 
        s.horaInicioReal = ahora.toLocaleTimeString();
        s.inspector = document.getElementById('r-inspector').value;
        s.proceso = document.getElementById('r-proceso').value;
        s.ansi = document.getElementById('r-ansi').value;
        s.productoActivo = (document.getElementById('contenedor-hibrida').style.display === 'block') ? document.getElementById('r-producto-especifico').value : lineasArr[idx];
        inputLote.value = "";
        cerrarModal('modal-reg'); render();
        guardarEstadoPizarraEnNube();
    }

async function finalizarLote(ok) {
    const s = estados[indexSel]; 
    const ahora = new Date();
    const diffMs = Date.now() - s.inicio;
    const min = Math.floor(diffMs / 60000).toString().padStart(2, '0');
    const seg = Math.floor((diffMs % 60000) / 1000).toString().padStart(2, '0');
    const tiempoFinal = `${min}:${seg}`;
    
    let det = ok ? "OK" : Array.from(document.querySelectorAll('.m-rechazo')).map(sel => sel.value).join(", ");
    if (!ok && det === "") det = "Defecto no especificado";

    const registro = { 
        action: 'add', 
        fecha: ahora.toLocaleDateString(), 
        hora: s.horaInicioReal, 
        linea: s.productoOriginal, 
        producto: s.productoActivo, 
        inspector: s.inspector, 
        lote: s.lote, 
        proceso: s.proceso, 
        ansi: s.ansi, 
        tiempo: tiempoFinal, 
        resultado: ok ? "ACEPTADO" : "RECHAZADO", 
        detalle: det 
    };

    try {
        fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(registro) });
        dbHistorial.push(registro);
        s.activo = false; 
        s.tiempo = '00:00'; 
        s.horaInicioReal = '';
        cerrarModal('modal-fin'); 
        cerrarModal('modal-rechazos'); 
        render();
        guardarEstadoPizarraEnNube();
    } catch(e) {
        alert("Error al guardar: Revisa tu conexi√≥n.");
    }
}
    function verificarHibrida() {
        const idx = document.getElementById('r-linea').value;
        const nom = lineasArr[idx];
        const cont = document.getElementById('contenedor-hibrida');
        if (nom.includes(" / ")) {
            document.getElementById('r-producto-especifico').innerHTML = nom.split(" / ").map(p => `<option value="${p.trim()}">${p.trim()}</option>`).join('');
            cont.style.display = 'block';
        } else { cont.style.display = 'none'; }
    }

    function tick() {
        estados.forEach((s, i) => {
            if(s.activo) {
                const d = Math.floor((Date.now()-s.inicio)/1000);
                s.tiempo = `${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
                const el = document.getElementById(`t-${i}`); if(el) el.innerText = s.tiempo;
            }
        });
        document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
    }

    function mostrarTab(t) { document.getElementById('sec-yield').style.display = t === 'yield' ? 'block' : 'none'; document.getElementById('sec-gestion').style.display = t === 'gestion' ? 'block' : 'none'; }
    function filtrarYield() { const q = document.getElementById('busqueda-inspector').value.toLowerCase(); const filas = document.querySelectorAll('#yield-table-body tr'); filas.forEach(f => { f.style.display = f.cells[0].innerText.toLowerCase().includes(q) ? "" : "none"; }); }
    function filtrarLotesAdmin() { const q = document.getElementById('input-busqueda').value.toLowerCase(); const filas = document.querySelectorAll('#gestion-table-body tr'); filas.forEach(f => { f.style.display = f.cells[0].innerText.toLowerCase().includes(q) ? "" : "none"; }); }
    function calcularStatsYield() {
    const stats = {};
    dbHistorial.forEach(r => {
        const ins = r.inspector || "N/A";
        // Si el inspector no existe en nuestro objeto, lo creamos con valores iniciales
        if(!stats[ins]) {
            stats[ins] = { 
                ok: 0, 
                fail: 0, 
                total: 0,
                // A√±adimos rastreo por proceso para un an√°lisis m√°s profundo
                procesos: { Shaft: 0, Final: 0, HubBonding: 0 }
            };
        }
        
        stats[ins].total++;
        
        if(r.resultado === 'ACEPTADO') {
            stats[ins].ok++;
        } else {
            stats[ins].fail++;
            // Registramos en qu√© proceso fall√≥ (si el dato existe)
            if(r.proceso && stats[ins].procesos[r.proceso.replace(" ", "")] !== undefined) {
                stats[ins].procesos[r.proceso.replace(" ", "")]++;
            }
        }
    });
    return stats;
}
   function generarReporteYield() {
    const stats = calcularStatsYield();
    const tbody = document.getElementById('yield-table-body');
    
    tbody.innerHTML = Object.keys(stats).map(k => {
        const d = stats[k];
        const yieldPorcentaje = d.total > 0 ? ((d.ok / d.total) * 100).toFixed(1) : 0;
        
        // Determinamos el color seg√∫n el rendimiento
        const colorYield = yieldPorcentaje >= 95 ? 'var(--primary-green)' : (yieldPorcentaje < 85 ? 'var(--alert-red)' : '#f39c12');

        return `
            <tr>
                <td style="text-align:left; padding-left:20px;"><b>${k}</b></td>
                <td><span style="color:green">‚óè</span> ${d.ok}</td>
                <td><span style="color:red">‚óè</span> ${d.fail}</td>
                <td>${d.total}</td>
                <td style="font-weight:bold; color:${colorYield}; font-size:1.1em;">${yieldPorcentaje}%</td>
            </tr>`;
    }).join('');
}
    
    function abrirModal(id) { 
        document.getElementById(id).style.display = 'block'; 
        pausaSincro = true; 
    }

    function cerrarModal(id) { 
        document.getElementById(id).style.display = 'none'; 
        pausaSincro = false; 
    }

    function prepararFin(i) { indexSel = i; abrirModal('modal-fin'); }
    function abrirRechazos() { cerrarModal('modal-fin'); abrirModal('modal-rechazos'); generarDefectos(); }
    function generarDefectos() { const q = parseInt(document.getElementById('rech-qty').value) || 1; const c = document.getElementById('contenedor-defectos'); c.innerHTML = ""; for(let i=0; i<q; i++) c.innerHTML += `<select class="m-rechazo">${defectosLista.map(d => `<option>${d}</option>`).join('')}</select>`; }
    function generarDefectosAdmin() { const q = parseInt(document.getElementById('rech-qty-admin').value) || 1; const c = document.getElementById('contenedor-defectos-admin'); c.innerHTML = ""; for(let i=0; i<q; i++) c.innerHTML += `<select class="m-rechazo-admin">${defectosLista.map(d => `<option>${d}</option>`).join('')}</select>`; }
    function exportarExcelGeneral() { exportarExcel([...dbHistorial].reverse(), 'Reporte_General_QC'); }
    function exportarExcelYield() { const stats = calcularStatsYield(); let csv = "\uFEFFsep=;\nInspector;Aceptados;Rechazados;Total;Yield %\n"; Object.keys(stats).forEach(k => { const d = stats[k]; csv += `"${k}";"${d.ok}";"${d.fail}";"${d.total}";"${((d.ok/d.total)*100).toFixed(2)}%"\n`; }); descargarArchivo(csv, 'Yield_QC'); }
    function exportarExcelGestion() { exportarExcel([...dbHistorial].reverse(), 'Gestion_QC'); }
    function exportarExcel(datos, nombre) {
        if(!datos.length) return alert("Sin datos");
        let csv = "\uFEFFsep=;\nFecha;Hora;Linea;Producto;Inspector;Lote;Resultado;Detalle;Tiempo\n";
        datos.forEach(r => { csv += `"${r.fecha}";"${r.hora}";"${r.linea}";"${r.producto || r.linea}";"${r.inspector}";"${r.lote}";"${r.resultado}";"${r.detalle}";"${r.tiempo}"\n`; });
        descargarArchivo(csv, nombre);
    }
    function descargarArchivo(c, n) { const b = new Blob([c], { type: 'text/csv;charset=utf-8;' }); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = `${n}.csv`; l.click(); }

    // --- FUNCIONES DE SINCRONIZACI√ìN NUBE ---

    async function sincronizarConNube() {
        if (pausaSincro) return; 
        try {
            const res = await fetch(SHEETS_URL + "?get=pizarra");
            const datosNube = await res.json();
            if (JSON.stringify(estados) !== JSON.stringify(datosNube)) {
                estados = datosNube;
                dibujarPizarraSinGuardar();
            }
        } catch(e) { console.error("Error de sincronizaci√≥n"); }
    }

    function guardarEstadoPizarraEnNube() {
    // Si la sincronizaci√≥n est√° pausada (porque tienes un modal abierto), no enviamos nada
    if (pausaSincro) return;

    const dataToSend = { 
        action: 'save_pizarra', 
        estados: estados,
        // Agregamos metadatos para que el historial sea rastreable
        timestamp: new Date().getTime(),
        lastUpdateBy: document.getElementById('r-inspector').value || "Sistema",
        version: "13.8.5" 
    };

    fetch(SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors', // Importante para Google Apps Script
        body: JSON.stringify(dataToSend)
    }).catch(err => {
        console.error("Error cr√≠tico de sincronizaci√≥n:", err);
        // Opcional: podr√≠as mostrar una alerta visual si falla el internet
    });
}

    function dibujarPizarraSinGuardar() {
        const p = document.getElementById('pizarra');
        p.innerHTML = estados.map((s, i) => `
            <div class="card ${s.activo ? 'inspeccionando' : ''}">
                <div class="card-header">${s.productoActivo}</div>
                <div class="card-body">
                    ${s.activo ? `<div>üë§ ${s.inspector}</div><div class="lote-destacado">${s.lote}</div><div class="badge-info"><span>${s.proceso}</span> ‚Ä¢ <span>${s.ansi}</span></div><div class="timer-display" id="t-${i}">${s.tiempo}</div>` : '<div style="opacity:0.3; font-weight:bold;">DISPONIBLE</div>'}
                </div>
                ${s.activo ? `<button class="btn-card btn-terminar" onclick="prepararFin(${i})">TERMINAR</button>` : `<button class="btn-card btn-historial" onclick="abrirHistorialIndividual(${i})">HISTORIAL</button>`}
            </div>`).join('');
    }
</script>    
</body>
</html>