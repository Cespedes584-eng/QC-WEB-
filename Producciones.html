<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QC Tracker</title>
    <style>
        :root {
            /* Paleta unificada con el Dashboard */
            --bg-body: #ebedef; 
            --panel-bg: #ffffff; 
            --primary-dark: #24303c;    /* Azul oscuro del Dashboard */
            --primary-green: #468e5d;   /* Verde institucional */
            --alert-red: #da3633; 
            --text-dark: #333333; 
            --border: #d1d8d5;
        }
        
        body { background-color: var(--bg-body); color: var(--text-dark); font-family: 'Segoe UI', sans-serif; margin: 0; }
        
        /* Header ajustado al estilo oscuro del Dashboard */
        .header { 
            background: var(--primary-dark); 
            padding: 12px 25px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 3px solid var(--primary-green); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); 
            color: white;
        }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; padding: 20px; }
        
        /* Tarjetas con sombras m√°s suaves */
        .card { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; min-height: 320px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; }
        .card.inspeccionando { border: 2px solid var(--primary-green); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        
        /* Encabezados de tarjetas con el verde del logo */
        .card-header { background: var(--primary-green); padding: 12px; font-weight: bold; text-align: center; color: white; text-transform: uppercase; letter-spacing: 1px; }
        
        .card-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        .lote-destacado { font-size: 1.4em; font-weight: 800; margin: 5px 0; color: var(--primary-dark); }
        
        .badge-info { font-size: 0.75em; margin-bottom: 8px; color: var(--primary-green); }
        .badge-info span { background: #f0f4f1; padding: 2px 6px; border-radius: 4px; border: 1px solid #d1d8d5; }
        
        .timer-display { font-family: monospace; font-size: 1.7em; color: var(--primary-green); font-weight: bold; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        
        .btn-card { border: none; padding: 12px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-terminar { background: #546e7a; color: #fff; }
        .btn-terminar:hover { background: #37474f; }
        .btn-historial { background: #ffffff; color: var(--primary-green); border-top: 1px solid #eee; }
        .btn-historial:hover { background: #f9f9f9; }
        
        /* Botones principales */
        .btn-main { background: var(--primary-green); color: white; border: none; padding: 10px 18px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-main:hover { opacity: 0.9; }

        .modal, .airport-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 4000; }
        .modal-content { background: white; width: 90%; max-width: 500px; margin: 50px auto; padding: 25px; border-radius: 8px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        .airport-table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 10px; }
        .airport-table th { background: #f1f3f5; padding: 10px; border-bottom: 2px solid var(--primary-green); color: var(--primary-dark); }
        .airport-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        
        input, select { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        
        /* Bot√≥n Flotante */
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--primary-green); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; color: white; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: 0.3s; }
        .fab:hover { transform: scale(1.1); }

        .search-bar { background: #fff; border: 1px solid var(--border); padding: 12px; margin-bottom: 15px; font-size: 1em; border-radius: 4px; }
        
        /* Info de Usuario */
        .user-info { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); color: white; font-weight: bold; font-size: 0.9em; }
        
        .btn-excel-header { background: #27ae60; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85em; }
        
        /* Reloj estilo Dashboard */
        #reloj { font-family: monospace; font-size: 1.1em; background: rgba(0,0,0,0.3); color: #fff; padding: 4px 12px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); }
        
        /* Bot√≥n Volver estilo Dashboard */
        .btn-back { background: #455a64; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.3s; }
        .btn-back:hover { background: #263238; }

        h3 { color: var(--primary-dark); border-bottom: 2px solid var(--primary-green); padding-bottom: 8px; }
    </style>
</head>
<body onload="inicializarSistema()">

    <div class="header">
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="btn-back" onclick="location.href='index.html'">üè† VOLVER</button>
            <button id="btn-admin-access" class="btn-main" style="background:#5c6bc0; display: none;" onclick="abrirAdmin()">‚öôÔ∏è ADMIN</button>
            <span style="font-weight: 800; color: white; font-size: 1.2em; letter-spacing: 1px;">QC TRACKER V13.8</span>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="user-display" class="user-info">USUARIO</div>
            <button class="btn-excel-header" onclick="exportarExcelGeneral()">üìä EXCEL</button>
            <div id="reloj">00:00:00</div>
        </div>
    </div>

    <div id="pizarra" class="grid-container"></div>
    <div class="fab" onclick="abrirModal('modal-reg')">+</div>

    <div id="modal-admin" class="airport-modal">
    <div style="background: white; margin: 10px auto; width: 98%; max-width: 1150px; border-radius: 8px; padding: 25px; height: 90vh; overflow-y: auto; position: relative;">
        <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-admin')">√ó</button>
        <h2 style="color:var(--primary-dark); margin-top:0;">Panel de Control Admin</h2>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
            <button class="btn-main" style="height: 45px; background: var(--primary-green);" onclick="mostrarTab('yield')">üìä Rendimiento Yield</button>
            <button class="btn-main" style="height: 45px; background: var(--primary-green);" onclick="mostrarTab('gestion')">‚öôÔ∏è Gesti√≥n de Datos</button>
            <button class="btn-main" style="height: 45px; background: #6c757d;" onclick="mostrarTab('defectos')">üõ†Ô∏è Config. Defectos</button>
        </div>

        <div id="sec-yield">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px;">
                <input type="text" id="busqueda-inspector" class="search-bar" placeholder="üîç Buscar Inspector..." onkeyup="filtrarYield()" style="margin-bottom:0; flex-grow:1;">
                <button class="btn-excel-header" onclick="exportarExcelYield()">üì• EXCEL RENDIMIENTO</button>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:15px; flex-wrap: wrap; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #eee;">
                <button class="btn-main" style="background:#607d8b; font-size:0.75em; padding: 5px 10px;" onclick="filtrarPorFecha('hoy')">HOY</button>
                <button class="btn-main" style="background:#607d8b; font-size:0.75em; padding: 5px 10px;" onclick="filtrarPorFecha('todos')">TODO</button>
                <span id="rango-actual" style="margin-left:auto; font-weight:bold; color:var(--primary-green); font-size:0.85em; align-self:center;">üìç Viendo: Todo</span>
            </div>
            <table class="airport-table">
                <thead><tr><th>Inspector</th><th>Aceptados</th><th>Rechazados</th><th>Total</th><th>Yield %</th></tr></thead>
                <tbody id="yield-table-body"></tbody>
            </table>
        </div>

        <div id="sec-gestion" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; gap:10px;">
                <input type="text" id="input-busqueda" class="search-bar" placeholder="üîç Buscar por Lote # ..." onkeyup="filtrarLotesAdmin()" style="margin-bottom:0; flex-grow:1;">
                <button class="btn-excel-header" onclick="exportarExcelGestion()">üì• EXCEL GESTI√ìN</button>
            </div>
            <table class="airport-table">
                <thead><tr><th>Lote</th><th>L√≠nea Base</th><th>Resultado</th><th>Detalle/Defectos</th><th>Acci√≥n</th></tr></thead>
                <tbody id="gestion-table-body"></tbody>
            </table>
        </div>

        <div id="sec-defectos" style="display:none;">
            <h3 style="color:var(--primary-dark); border-bottom: 2px solid #8e44ad; padding-bottom: 8px; margin-top:0;">Configuraci√≥n de Defectos</h3>
            <div style="background:#f1f3f5; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border);">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div><label>1. L√≠nea:</label><select id="admin-def-linea" onchange="renderizarListaDefectosAdmin()" style="width:100%;"></select></div>
                    <div><label>2. Proceso:</label><select id="admin-def-proceso" onchange="renderizarListaDefectosAdmin()" style="width:100%;"><option>Shaft</option><option>Final</option><option>Hub Bonding</option></select></div>
                    <div><label>3. Defecto:</label><input type="text" id="admin-def-nombre" placeholder="Nombre..." style="width:100%;"></div>
                </div>
                <button class="btn-main" style="width:100%; background:#8e44ad;" onclick="agregarDefectoNuevo()">Ôºã GUARDAR EN CAT√ÅLOGO</button>
            </div>
            <table class="airport-table">
                <thead><tr><th>Defecto Registrado</th><th style="width: 80px;">Acci√≥n</th></tr></thead>
                <tbody id="lista-defectos-configurados-tabla"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="modal-defecto-admin" class="modal">
    <div class="modal-content">
        <h3 style="color:var(--alert-red);">Cambiar a Rechazado</h3>
        <label>Cantidad de Defectos:</label>
        <input type="number" id="rech-qty-admin" value="1" min="1" onchange="generarDefectosAdmin()">
        <div id="contenedor-defectos-admin" style="margin-bottom: 15px;"></div>
        <button class="btn-main" style="width:100%; background:var(--alert-red);" onclick="confirmarCambioRechazo()">ACTUALIZAR REGISTRO</button>
        <button class="btn-main" style="width:100%; background:#ccc; margin-top:10px;" onclick="cerrarModal('modal-defecto-admin')">CANCELAR</button>
    </div>
</div>

<div id="modal-historial-linea" class="airport-modal">
    <div style="background: white; margin: 20px auto; width: 95%; max-width: 1000px; border-radius: 8px; padding: 25px; height: 80vh; overflow-y: auto; position: relative;">
        <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-historial-linea')">√ó</button>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="hist-linea-titulo"></h3>
            <button id="btn-descarga-individual" class="btn-excel-header">üì• DESCARGAR</button>
        </div>
        <input type="text" id="busqueda-lote-historial" class="search-bar" placeholder="üîç Filtrar..." onkeyup="filtrarLoteHistorialIndividual()">
        <table class="airport-table">
            <thead><tr><th>Fecha</th><th>Hora Inicio</th><th>Lote</th><th>Inspector</th><th>Resultado</th><th>Duraci√≥n</th><th>Defecto</th></tr></thead>
            <tbody id="hist-linea-body"></tbody>
        </table>
    </div>
</div>

<div id="modal-reg" class="modal">
    <div class="modal-content">
        <button style="position:absolute; top:15px; right:20px; font-size:25px; border:none; background:none; cursor:pointer;" onclick="cerrarModal('modal-reg')">√ó</button>
        <h3>Nueva Inspecci√≥n</h3>
        <label>L√≠nea</label><select id="r-linea" onchange="verificarHibrida()"></select>
        <div id="contenedor-hibrida" style="display:none; background: #f0f4f1; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid var(--border);">
            <label>Producto Espec√≠fico:</label><select id="r-producto-especifico"></select>
        </div>
        <input type="text" id="r-lote" placeholder="Lote #">
        <input type="text" id="r-inspector" readonly style="background:#f1f1f1;">
        <select id="r-proceso"><option>Shaft</option><option>Final</option><option>Hub Bonding</option></select>
        <select id="r-ansi"><option>Normal</option><option>Reducido</option><option>Riguroso</option></select>
        <button class="btn-main" style="width:100%;" onclick="iniciarLote()">INICIAR INSPECCI√ìN</button>
    </div>
</div>

<div id="modal-fin" class="modal"><div class="modal-content"><h3>¬øLote Aceptado?</h3><button class="btn-main" style="width:100%;" onclick="finalizarLote(true)">ACEPTAR</button><button class="btn-main" style="background:var(--alert-red); width:100%; margin-top:10px;" onclick="abrirRechazos()">RECHAZAR</button></div></div>
<div id="modal-rechazos" class="modal">
    <div class="modal-content" style="position: relative; padding-top: 35px;">
        <button style="position:absolute; top:10px; right:15px; font-size:25px; border:none; background:none; cursor:pointer; color:#888;" onclick="cerrarModal('modal-rechazos')">√ó</button>
        
        <h3 style="color:var(--alert-red); margin-top:0;">Defectos Detectados</h3>
        
        <label style="display:block; font-size:12px; font-weight:bold; margin-bottom:5px;">Cantidad de piezas rechazadas:</label>
        <input type="number" id="rech-qty" value="1" min="1" oninput="generarDefectos()" onchange="generarDefectos()" style="width:100%; margin-bottom:15px;">
        
        <div id="contenedor-defectos" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px; padding-right: 5px;">
            </div>
        
        <button class="btn-main" style="background:var(--alert-red); width:100%;" onclick="finalizarLote(false)">GUARDAR RECHAZO</button>
    </div>
</div>
    <script>

    // Variable para que no se crucen los datos mientras escribes
    let pausaSincro = false;

    const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxdRMoY6kcLGmUG19zIFxVLmv12MRaY00v8EzTqDyZ7dtHAN7ua087hjEylv-fpRtcI/exec";
    const lineasArr = ["SOFIA 6F L1", "SOFIA 6F L2 / 5F L2", "SOFIA 6F L3 / EX", "SOFIA 5F", "VIA / HW 27", "SCEPTER", "HW LONG", "HW SHORT / REGULAR L2", "HW 21 +", "HW REGULAR"];
   let isFinalizing = false; // Esta vpariable ser√° nuestro sem√°foro
 // --- NUEVO SISTEMA DE CAT√ÅLOGO DE DEFECTOS ---
// Estructura: catalogoDefectos["LINEA"]["PROCESO"] = ["Defecto A", "Defecto B"]
let catalogoDefectos = JSON.parse(localStorage.getItem('qc_catalogo_v2')) || {};

// Esta funci√≥n guarda tus cambios para que no se borren al refrescar
function guardarCatalogo() {
    // 1. Guardar en la memoria local del navegador (como respaldo r√°pido)
    localStorage.setItem('qc_catalogo_v2', JSON.stringify(catalogoDefectos));

    // 2. Enviar a la nube (Google Sheets)
    const payload = {
        action: 'save_config',
        datos: catalogoDefectos
    };

    fetch(SHEETS_URL, {
        method: 'POST',
        mode: 'no-cors', // Importante para evitar bloqueos de seguridad simples
        body: JSON.stringify(payload)
    })
    .then(() => {
        console.log("Sincronizaci√≥n con Google Sheets exitosa");
        alert("‚úÖ Cat√°logo actualizado y guardado en la nube.");
    })
    .catch(error => {
        console.error("Error al sincronizar:", error);
        alert("‚ùå Error al guardar en la nube, pero se guard√≥ localmente.");
    });
}
// Defectos de respaldo por si una l√≠nea no tiene nada configurado a√∫n
const defectosRespaldo = ["Visual", "Derrame", "Medida", "Empaque", "Otro"];
    let estados = []; let dbHistorial = []; let indexSel = null; let adminEditTemp = { idx: null, valor: null };

 function inicializarSistema() {
    // 1. Recuperar sesi√≥n (Usuario e Inspector)
    const sesion = localStorage.getItem('qc_session');
    if(sesion) {
        const data = JSON.parse(sesion);
        document.getElementById('user-display').innerText = `üë§ ${data.name.toUpperCase()}`;
        document.getElementById('r-inspector').value = data.name.toUpperCase();
        if(data.isAdmin) {
            const btnAdmin = document.getElementById('btn-admin-access');
            if(btnAdmin) btnAdmin.style.display = 'inline-block';
        }
    }

    // --- CIRUG√çA DE CARGA R√ÅPIDA ---
    // 2. Intentar cargar el respaldo local de la pizarra inmediatamente
    const respaldoLocal = localStorage.getItem('qc_v13_respaldo');
    
    if (respaldoLocal) {
        // Si hay respaldo, lo usamos para no mostrar la pantalla vac√≠a
        estados = JSON.parse(respaldoLocal);
    } else {
        // Si es la primera vez (computadora nueva), creamos la estructura base
        estados = lineasArr.map(nom => ({ 
            activo: false, lote: '', inspector: '', inicio: null, horaInicioReal: '', 
            tiempo: '00:00', productoActivo: nom.split(" / ")[0].trim(), 
            productoOriginal: nom, proceso: 'Final', ansi: 'Normal' 
        }));
    }

    // 3. Llenar el selector de l√≠neas
    const selL = document.getElementById('r-linea');
    if(selL) selL.innerHTML = lineasArr.map((n, i) => `<option value="${i}">${n}</option>`).join('');
    
    // 4. Dibujar la pizarra con lo que tenemos a mano
    render();

    // 5. Iniciar reloj y sincronizaci√≥n real con la nube
    setInterval(tick, 1000);
    sincronizarConNube(); // Esta ir√° por los datos "frescos" a Google
    setInterval(sincronizarConNube, 10000); 
}

    async function cargarHistorialNube() {
        try { const res = await fetch(SHEETS_URL); const datos = await res.json(); dbHistorial = datos.historial || []; } catch(e) { console.error("Error conexi√≥n"); }
    }

// NUEVA FUNCI√ìN: Solo para traer la configuraci√≥n de defectos
async function sincronizarConfiguracionDefectos() {
    try { 
        const res = await fetch(SHEETS_URL); 
        const datos = await res.json(); 
        
        // Solo actualizamos el cat√°logo si el servidor envi√≥ la secci√≥n 'config'
        if (datos.config && datos.config.CATALOGO_DEFECTOS) {
            const catalogoNube = JSON.parse(datos.config.CATALOGO_DEFECTOS);
            
            // Verificamos que no venga vac√≠o para no borrar lo que tienes en pantalla
            if (Object.keys(catalogoNube).length > 0) {
                catalogoDefectos = catalogoNube;
                console.log("Cat√°logo de defectos sincronizado desde la nube.");
            }
        }
    } catch(e) { 
        console.warn("No se pudo sincronizar el cat√°logo, se mantiene el local.", e); 
    }
}
    function formatearTexto(valor) {
        if (!valor) return "";
        let str = String(valor);
        if (str.includes("T")) {
            let partes = str.split("T");
            return partes[1] ? partes[1].substring(0, 8) : partes[0];
        }
        return str;
    }

    function render() {
    const p = document.getElementById('pizarra');
    if (!p) return; // Seguridad por si el elemento no existe a√∫n

    p.innerHTML = estados.map((s, i) => `
        <div class="card ${s.activo ? 'inspeccionando' : ''}">
            <div class="card-header">${s.productoActivo}</div>
            <div class="card-body">
                ${s.activo ? `
                    <div>üë§ ${s.inspector}</div>
                    <div class="lote-destacado">${s.lote}</div>
                    <div class="badge-info"><span>${s.proceso}</span> ‚Ä¢ <span>${s.ansi}</span></div>
                    <div class="timer-display" id="t-${i}">${s.tiempo}</div>
                ` : '<div style="opacity:0.3; font-weight:bold;">DISPONIBLE</div>'}
            </div>
            ${s.activo ? 
                <button id="btn-terminar-${i}" class="btn-card btn-terminar" onclick="prepararFin(${i})">TERMINAR</button> : 
                `<button class="btn-card btn-historial" onclick="abrirHistorialIndividual(${i})">HISTORIAL</button>`
            }
        </div>`).join('');
    
    // Guardamos en LocalStorage para que la carga inicial sea r√°pida
    localStorage.setItem('qc_v13_respaldo', JSON.stringify(estados));
    
    // NOTA: Hemos quitado guardarEstadoPizarraEnNube() de aqu√≠ para evitar bucles.
    // El env√≠o a la nube ahora solo se hace en iniciarLote() y finalizarLote().
}

    function abrirHistorialIndividual(idx) {
        const nom = lineasArr[idx];
        document.getElementById('hist-linea-titulo').innerText = "Historial: " + nom;
        document.getElementById('busqueda-lote-historial').value = "";
        const filtrados = dbHistorial.filter(r => r.linea === nom).reverse();
        document.getElementById('hist-linea-body').innerHTML = filtrados.map(r => `
            <tr>
                <td>${formatearTexto(r.fecha)}</td>
                <td>${formatearTexto(r.hora)}</td>
                <td><b>${r.lote}</b></td>
                <td>${r.inspector}</td>
                <td style="color:${r.resultado==='ACEPTADO'?'green':'red'}; font-weight:bold;">${r.resultado}</td>
                <td>${r.tiempo}</td>
                <td>${r.detalle}</td>
            </tr>`).join('');
        document.getElementById('btn-descarga-individual').onclick = () => exportarExcel(filtrados, `Historial_${nom.replace(/ /g, "_")}`);
        abrirModal('modal-historial-linea');
    }

    function filtrarLoteHistorialIndividual() {
        const query = document.getElementById('busqueda-lote-historial').value.toLowerCase();
        const filas = document.querySelectorAll('#hist-linea-body tr');
        filas.forEach(f => { f.style.display = f.cells[2].innerText.toLowerCase().includes(query) ? "" : "none"; });
    }

    function abrirAdmin() { abrirModal('modal-admin'); cargarHistorialNube().then(() => { generarReporteYield(); generarGestionLotes(); }); }
    
   function generarGestionLotes() {
    const ultimos = [...dbHistorial].reverse();
    document.getElementById('gestion-table-body').innerHTML = ultimos.map((r, i) => {
        const realIdx = dbHistorial.length - 1 - i;
        // Esta es la parte pesada: crear los selectores de edici√≥n para cada fila
        return `<tr>
            <td><b>${r.lote}</b></td>
            <td>
                <select onchange="adminModificar(${realIdx}, 'linea', this.value)">
                    ${lineasArr.map(l => `<option ${r.linea===l?'selected':''}>${l}</option>`).join('')}
                </select>
            </td>
            <td>
                <select onchange="adminModificar(${realIdx}, 'resultado', this.value)" 
                        style="color:${r.resultado==='ACEPTADO'?'green':'red'}; font-weight:bold;">
                    <option value="ACEPTADO" ${r.resultado==='ACEPTADO'?'selected':''}>ACEPTADO</option>
                    <option value="RECHAZADO" ${r.resultado==='RECHAZADO'?'selected':''}>RECHAZADO</option>
                </select>
            </td>
            <td><input type="text" value="${r.detalle}" onchange="adminModificar(${realIdx}, 'detalle', this.value)" style="width:90%"></td>
            <td><button onclick="borrarRegistro(${realIdx})" style="background:none; border:none; cursor:pointer;">üóëÔ∏è</button></td>
        </tr>`;
    }).join('');
}

    function adminModificar(idx, campo, valor) {
        if (campo === 'resultado' && valor === 'RECHAZADO') {
            adminEditTemp = { idx, valor };
            document.getElementById('rech-qty-admin').value = 1;
            generarDefectosAdmin();
            abrirModal('modal-defecto-admin');
        } else {
            dbHistorial[idx][campo] = valor;
            if (campo === 'resultado' && valor === 'ACEPTADO') dbHistorial[idx].detalle = "OK";
            ejecutarSync(dbHistorial[idx]);
        }
    }

    function confirmarCambioRechazo() {
        const r = dbHistorial[adminEditTemp.idx];
        const defectos = Array.from(document.querySelectorAll('.m-rechazo-admin')).map(sel => sel.value).join(", ");
        r.resultado = 'RECHAZADO';
        r.detalle = defectos;
        ejecutarSync(r);
        cerrarModal('modal-defecto-admin');
    }

    function ejecutarSync(registro) {
        fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'edit', ...registro }) });
        generarReporteYield(); generarGestionLotes();
    }
function borrarRegistro(idx) {
    if (!confirm("¬øEst√°s seguro de que deseas eliminar este registro? Esta acci√≥n no se puede deshacer en la base de datos.")) return;

    const registroABorrar = dbHistorial[idx];
    
    // Enviamos la instrucci√≥n de borrado a Google Sheets
    fetch(SHEETS_URL, { 
        method: 'POST', 
        mode: 'no-cors', 
        body: JSON.stringify({ 
            action: 'delete', 
            lote: registroABorrar.lote,
            fecha: registroABorrar.fecha,
            hora: registroABorrar.hora 
        }) 
    });

    // Lo eliminamos visualmente de inmediato
    dbHistorial.splice(idx, 1);
    generarGestionLotes();
    generarReporteYield();
    alert("Registro eliminado localmente. La nube se actualizar√° en breve.");
}

    function iniciarLote() {
        const inputLote = document.getElementById('r-lote');
        const lVal = inputLote.value.trim();
        if(!lVal) return alert("Ingrese Lote");
        const idx = document.getElementById('r-linea').value;
        const s = estados[idx];
        const ahora = new Date();
        s.activo = true; 
        s.lote = lVal; 
        s.inicio = ahora.getTime(); 
        s.horaInicioReal = ahora.toLocaleTimeString();
        s.inspector = document.getElementById('r-inspector').value;
        s.proceso = document.getElementById('r-proceso').value;
        s.ansi = document.getElementById('r-ansi').value;
        s.productoActivo = (document.getElementById('contenedor-hibrida').style.display === 'block') ? document.getElementById('r-producto-especifico').value : lineasArr[idx];
        inputLote.value = "";
        cerrarModal('modal-reg'); render();
        guardarEstadoPizarraEnNube();
    }
async function finalizarLote(ok) {
    // --- CIRUG√çA 1: El Bloqueo L√≥gico ---
    if (isFinalizing) return; 
    isFinalizing = true; 

    // --- NUEVO: Bloqueo Visual del Bot√≥n ---
    // Buscamos el bot√≥n espec√≠fico en la pizarra usando el ID que a√±adiremos al HTML
    const botonPizarra = document.getElementById(`btn-terminar-${indexSel}`);
    let textoOriginal = "";
    if (botonPizarra) {
        textoOriginal = botonPizarra.innerText;
        botonPizarra.disabled = true;
        botonPizarra.innerText = "GUARDANDO...";
        botonPizarra.style.opacity = "0.5";
    }

    const s = estados[indexSel]; 
    const ahora = new Date();
    const diffMs = Date.now() - s.inicio;
    const min = Math.floor(diffMs / 60000).toString().padStart(2, '0');
    const seg = Math.floor((diffMs % 60000) / 1000).toString().padStart(2, '0');
    const tiempoFinal = `${min}:${seg}`;
    
    let det = ok ? "OK" : Array.from(document.querySelectorAll('.m-rechazo')).map(sel => sel.value).join(", ");
    if (!ok && det === "") det = "Defecto no especificado";

    const registro = { 
        action: 'add', 
        fecha: ahora.toLocaleDateString(), 
        hora: s.horaInicioReal, 
        linea: s.productoOriginal, 
        producto: s.productoActivo, 
        inspector: s.inspector, 
        lote: s.lote, 
        proceso: s.proceso, 
        ansi: s.ansi, 
        tiempo: tiempoFinal, 
        resultado: ok ? "ACEPTADO" : "RECHAZADO", 
        detalle: det 
    };

    try {
        // --- CIRUG√çA 2: Esperar el env√≠o (await) ---
        await fetch(SHEETS_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(registro) 
        });
        
        dbHistorial.push(registro);
        s.activo = false; 
        s.tiempo = '00:00'; 
        s.horaInicioReal = '';
        
        cerrarModal('modal-fin'); 
        cerrarModal('modal-rechazos'); 
        
        // El render() volver√° a dibujar la pizarra, eliminando el bot√≥n viejo
        render();
        guardarEstadoPizarraEnNube();

    } catch(e) {
        alert("Error al guardar: Revisa tu conexi√≥n.");
        // Si fall√≥, regresamos el bot√≥n a su estado normal
        if (botonPizarra) {
            botonPizarra.disabled = false;
            botonPizarra.innerText = textoOriginal;
            botonPizarra.style.opacity = "1";
        }
        isFinalizing = false; 
    } finally {
        // --- CIRUG√çA 3: Liberaci√≥n segura ---
        setTimeout(() => { isFinalizing = false; }, 3000);
    }
}

// ESTA ES LA FUNCI√ìN QUE TE FALTABA PARA QUE EL BOT√ìN FUNCIONE
function prepararFin(i) {
    indexSel = i; 
    abrirModal('modal-fin');
}
    function verificarHibrida() {
        const idx = document.getElementById('r-linea').value;
        const nom = lineasArr[idx];
        const cont = document.getElementById('contenedor-hibrida');
        if (nom.includes(" / ")) {
            document.getElementById('r-producto-especifico').innerHTML = nom.split(" / ").map(p => `<option value="${p.trim()}">${p.trim()}</option>`).join('');
            cont.style.display = 'block';
        } else { cont.style.display = 'none'; }
    }

    function tick() {
        estados.forEach((s, i) => {
            if(s.activo) {
                const d = Math.floor((Date.now()-s.inicio)/1000);
                s.tiempo = `${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
                const el = document.getElementById(`t-${i}`); if(el) el.innerText = s.tiempo;
            }
        });
        document.getElementById('reloj').innerText = new Date().toLocaleTimeString();
    }

    // Actualizamos mostrarTab para incluir la pesta√±a de defectos
function mostrarTab(t) { 
    document.getElementById('sec-yield').style.display = t === 'yield' ? 'block' : 'none'; 
    document.getElementById('sec-gestion').style.display = t === 'gestion' ? 'block' : 'none'; 
    document.getElementById('sec-defectos').style.display = t === 'defectos' ? 'block' : 'none'; 
    
    if(t === 'defectos') {
        inicializarSelectoresAdmin();
    }
}

// Llena el selector de l√≠neas del panel admin usando tu array lineasArr
function inicializarSelectoresAdmin() {
    const selL = document.getElementById('admin-def-linea');
    if(selL.options.length === 0) { // Solo llenar si est√° vac√≠o
        selL.innerHTML = lineasArr.map(n => `<option value="${n}">${n}</option>`).join('');
    }
    renderizarListaDefectosAdmin();
}

// Dibuja los cuadritos de los defectos que ya existen
function renderizarListaDefectosAdmin() {
    const linea = document.getElementById('admin-def-linea').value;
    const proceso = document.getElementById('admin-def-proceso').value;
    const tbody = document.getElementById('lista-defectos-configurados-tabla');
    
    if (!tbody) return; // Seguridad por si el ID no existe
    
    // Obtener la lista del cat√°logo
    const lista = (catalogoDefectos[linea] && catalogoDefectos[linea][proceso]) 
                  ? catalogoDefectos[linea][proceso] 
                  : [];
    
    if (lista.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" style="color:#999; padding:20px; text-align:center;">No hay defectos para esta selecci√≥n.</td></tr>`;
        return;
    }

    // Generar las filas con el bot√≥n de borrar
    tbody.innerHTML = lista.map((def, i) => `
        <tr>
            <td style="text-align:left; padding-left:20px; font-weight:bold; color:var(--primary-dark);">${def}</td>
            <td style="text-align:center;">
                <button onclick="eliminarDefecto('${linea}', '${proceso}', ${i})" style="background:none; border:none; cursor:pointer; font-size:1.2em;">üóëÔ∏è</button>
            </td>
        </tr>
    `).join('');
}
// Agrega un nuevo defecto a la memoria
function agregarDefectoNuevo() {
    const linea = document.getElementById('admin-def-linea').value;
    const proceso = document.getElementById('admin-def-proceso').value;
    const inputNombre = document.getElementById('admin-def-nombre');
    const nombre = inputNombre.value.trim();

    if (!nombre) {
        alert("Escribe el nombre del defecto");
        return;
    }

    // Inicializar estructura si no existe
    if (!catalogoDefectos[linea]) catalogoDefectos[linea] = {};
    if (!catalogoDefectos[linea][proceso]) catalogoDefectos[linea][proceso] = [];

    // Evitar duplicados
    if (catalogoDefectos[linea][proceso].includes(nombre)) {
        alert("Este defecto ya existe");
        return;
    }

    // Guardar en el objeto
    catalogoDefectos[linea][proceso].push(nombre);
    
    // Guardar en LocalStorage y Nube
    guardarCatalogo();

    // LIMPIAR INPUT
    inputNombre.value = "";

    // REFRESCAR LA TABLA INMEDIATAMENTE
    renderizarListaDefectosAdmin();
}
// Borra un defecto de la memoria
function eliminarDefecto(linea, proceso, index) {
    if(confirm("¬øDeseas eliminar este defecto?")) {
        catalogoDefectos[linea][proceso].splice(index, 1);
        guardarCatalogo();
        renderizarListaDefectosAdmin();
    }
}
    function filtrarYield() { const q = document.getElementById('busqueda-inspector').value.toLowerCase(); const filas = document.querySelectorAll('#yield-table-body tr'); filas.forEach(f => { f.style.display = f.cells[0].innerText.toLowerCase().includes(q) ? "" : "none"; }); }
    function filtrarLotesAdmin() { const q = document.getElementById('input-busqueda').value.toLowerCase(); const filas = document.querySelectorAll('#gestion-table-body tr'); filas.forEach(f => { f.style.display = f.cells[0].innerText.toLowerCase().includes(q) ? "" : "none"; }); }
    function calcularStatsYield() {
    const stats = {};
    dbHistorial.forEach(r => {
        const ins = r.inspector || "N/A";
        // Si el inspector no existe en nuestro objeto, lo creamos con valores iniciales
        if(!stats[ins]) {
            stats[ins] = { 
                ok: 0, 
                fail: 0, 
                total: 0,
                // A√±adimos rastreo por proceso para un an√°lisis m√°s profundo
                procesos: { Shaft: 0, Final: 0, HubBonding: 0 }
            };
        }
        
        stats[ins].total++;
        
        if(r.resultado === 'ACEPTADO') {
            stats[ins].ok++;
        } else {
            stats[ins].fail++;
            // Registramos en qu√© proceso fall√≥ (si el dato existe)
            if(r.proceso && stats[ins].procesos[r.proceso.replace(" ", "")] !== undefined) {
                stats[ins].procesos[r.proceso.replace(" ", "")]++;
            }
        }
    });
    return stats;
}
// --- PEGAR ESTO ANTES DE generarReporteYield ---
let filtroFechaActual = 'todos';

function filtrarPorFecha(rango) {
    filtroFechaActual = rango;
    const etiquetas = { 
        'hoy': 'Hoy', 
        'ayer': 'Ayer', 
        'semana': 'Esta Semana', 
        'mes': 'Este Mes', 
        'todos': 'Todo el Historial' 
    };
    document.getElementById('rango-actual').innerText = "üìç Viendo: " + etiquetas[rango];
    generarReporteYield();
}
// ----------------------------------------------
   function generarReporteYield() {
    const ahora = new Date();
    const hoyStr = ahora.toLocaleDateString();
    
    // Funci√≥n auxiliar para entender fechas en formato DD/MM/YYYY
    const parseFecha = (str) => {
        const p = str.split('/');
        return new Date(p[2], p[1] - 1, p[0]);
    };

    // 1. Filtrar el historial seg√∫n el bot√≥n presionado
    const filtrados = dbHistorial.filter(r => {
        if (filtroFechaActual === 'todos') return true;
        
        const fechaReg = r.fecha; // Ya viene como string DD/MM/YYYY
        
        if (filtroFechaActual === 'hoy') return fechaReg === hoyStr;
        
        if (filtroFechaActual === 'ayer') {
            const ayer = new Date(); ayer.setDate(ayer.getDate() - 1);
            return fechaReg === ayer.toLocaleDateString();
        }
        
        if (filtroFechaActual === 'semana') {
            const fechaDoc = parseFecha(fechaReg);
            const diffDias = (ahora - fechaDoc) / (1000 * 60 * 60 * 24);
            return diffDias <= 7;
        }
        
        if (filtroFechaActual === 'mes') {
            return fechaReg.split('/')[1] === hoyStr.split('/')[1] && 
                   fechaReg.split('/')[2] === hoyStr.split('/')[2];
        }
        return true;
    });

    // 2. Calcular estad√≠sticas sobre los datos ya filtrados
    const stats = {};
    filtrados.forEach(r => {
        const ins = r.inspector || "N/A";
        if(!stats[ins]) stats[ins] = { ok: 0, fail: 0, total: 0 };
        stats[ins].total++;
        if(r.resultado === 'ACEPTADO') stats[ins].ok++; else stats[ins].fail++;
    });

    // 3. Dibujar la tabla
    const tbody = document.getElementById('yield-table-body');
    tbody.innerHTML = Object.keys(stats).map(k => {
        const d = stats[k];
        const yieldPor = d.total > 0 ? ((d.ok / d.total) * 100).toFixed(1) : 0;
        const color = yieldPor >= 95 ? 'green' : (yieldPor < 85 ? 'red' : '#f39c12');
        return `<tr>
            <td style="text-align:left; padding-left:15px;"><b>${k}</b></td>
            <td>${d.ok}</td><td>${d.fail}</td><td>${d.total}</td>
            <td style="font-weight:bold; color:${color}">${yieldPor}%</td>
        </tr>`;
    }).join('');
}
    
// --- FUNCIONES DE CONTROL DE MODALES ---
function abrirModal(id) { 
    const el = document.getElementById(id);
    if(el) el.style.display = 'block'; 
    pausaSincro = true; 
}

function cerrarModal(id) { 
    const el = document.getElementById(id);
    if(el) el.style.display = 'none'; 
    pausaSincro = false; 
}

function prepararFin(i) {
    const s = estados[i];
    const sesionJSON = localStorage.getItem('qc_session');
    
    if (!sesionJSON) {
        alert("Sesi√≥n no encontrada. Por favor reingresa al sistema.");
        return;
    }

    const sesion = JSON.parse(sesionJSON);
    const usuarioActual = sesion.name.toUpperCase();
    const inspectorLote = s.inspector.toUpperCase();

    // Solo el due√±o del lote o Admin pueden terminarlo
    if (usuarioActual === inspectorLote || sesion.isAdmin === true) {
        indexSel = i;
        abrirModal('modal-fin');
    } else {
        alert(`‚õî BLOQUEADO\n\nLote de: ${s.inspector}\nTu usuario: ${sesion.name}\n\nSolo el responsable o un Administrador pueden finalizar.`);
    }
}

function abrirRechazos() { 
    cerrarModal('modal-fin'); 
    abrirModal('modal-rechazos'); 
    generarDefectos(); 
}

function generarDefectos() { 
    const q = parseInt(document.getElementById('rech-qty').value) || 0; 
    const c = document.getElementById('contenedor-defectos'); 
    
    // 1. Limpiamos el contenedor para que no se amontonen
    c.innerHTML = ""; 
    
    // 2. Obtenemos los datos del lote que se est√° inspeccionando actualmente
    const loteActual = estados[indexSel];
    if (!loteActual) return;

    const lineaActual = loteActual.productoOriginal || loteActual.productoActivo; 
    const procesoActual = loteActual.proceso;

    // 3. Buscamos qu√© defectos hay guardados para esa l√≠nea/proceso en el Admin
    let opcionesDefectos = (catalogoDefectos[lineaActual] && catalogoDefectos[lineaActual][procesoActual]) 
                           ? catalogoDefectos[lineaActual][procesoActual] 
                           : ["Visual", "Derrame", "Medida", "Otro"]; // Lista por defecto si no hay nada en Admin

    // 4. Creamos un selector por cada cantidad (Q) indicada
    for(let i = 0; i < q; i++) {
        const divGrupo = document.createElement('div');
        divGrupo.style.marginBottom = "10px";
        
        const label = document.createElement('label');
        label.innerHTML = `<small>Defecto pieza ${i+1}:</small>`;
        label.style.display = "block";
        label.style.fontSize = "10px";
        
        const select = document.createElement('select');
        select.className = "m-rechazo"; // Esta clase es la que usas para guardar el resultado
        select.style.width = "100%";
        select.style.padding = "8px";
        select.style.border = "1px solid var(--alert-red)";
        select.style.borderRadius = "4px";
        
        // Llenamos el selector con las opciones del cat√°logo
        opcionesDefectos.forEach(def => {
            const opt = document.createElement('option');
            opt.value = def;
            opt.textContent = def;
            select.appendChild(opt);
        });
        
        divGrupo.appendChild(label);
        divGrupo.appendChild(select);
        c.appendChild(divGrupo);
    }
}
// --- FUNCIONES DE INTERFAZ Y EXCEL ---
function dibujarPizarraSinGuardar() {
    const p = document.getElementById('pizarra');
    if(!p) return;
    p.innerHTML = estados.map((s, i) => `
        <div class="card ${s.activo ? 'inspeccionando' : ''}">
            <div class="card-header">${s.productoActivo}</div>
            <div class="card-body">
                ${s.activo ? `
                    <div>üë§ ${s.inspector}</div>
                    <div class="lote-destacado">${s.lote}</div>
                    <div class="badge-info"><span>${s.proceso}</span> ‚Ä¢ <span>${s.ansi}</span></div>
                    <div class="timer-display" id="t-${i}">${s.tiempo}</div>
                ` : '<div style="opacity:0.3; font-weight:bold;">DISPONIBLE</div>'}
            </div>
            ${s.activo ? 
                `<button class="btn-card btn-terminar" onclick="prepararFin(${i})">TERMINAR</button>` : 
                `<button class="btn-card btn-historial" onclick="abrirHistorialIndividual(${i})">HISTORIAL</button>`
            }
        </div>`).join('');
}

function exportarExcelGeneral() { exportarExcel([...dbHistorial].reverse(), 'Reporte_General_QC'); }
function exportarExcelGestion() { exportarExcel([...dbHistorial].reverse(), 'Gestion_QC'); }

function exportarExcelYield() {
    const stats = calcularStatsYield();
    let csv = "\uFEFFsep=;\nInspector;Aceptados;Rechazados;Total;Yield %\n";
    Object.keys(stats).forEach(k => {
        const d = stats[k];
        const y = d.total > 0 ? ((d.ok / d.total) * 100).toFixed(1) : 0;
        csv += `"${k}";"${d.ok}";"${d.fail}";"${d.total}";"${y}%"\n`;
    });
    descargarArchivo(csv, 'Reporte_Yield_Inspectores');
}

function exportarExcel(datos, nombre) {
    if (datos.length === 0) return alert("No hay datos para exportar");
    // Encabezados con Proceso y ANSI incluidos
    let csv = "\uFEFFsep=;\nFecha;Hora;Linea;Producto;Inspector;Lote;Proceso;ANSI;Resultado;Tiempo;Detalle\n";
    datos.forEach(r => {
        csv += `"${r.fecha}";"${r.hora}";"${r.linea}";"${r.producto}";"${r.inspector}";"${r.lote}";"${r.proceso}";"${r.ansi}";"${r.resultado}";"${r.tiempo}";"${r.detalle}"\n`;
    });
    descargarArchivo(csv, nombre);
}

function descargarArchivo(contenido, nombre) {
    const blob = new Blob([contenido], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    const fechaFila = new Date().toLocaleDateString().replace(/\//g, '-');
    link.setAttribute("download", `${nombre}_${fechaFila}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- PERSISTENCIA Y SINCRONIZACI√ìN ---
async function guardarEstadoPizarraEnNube() {
    if (pausaSincro) return;
    try {
        const payload = {
            action: 'save_pizarra',
            estados: estados,
            lastUpdateBy: document.getElementById('r-inspector').value || "Sistema"
        };
        fetch(SHEETS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    } catch (e) { console.warn("Fallo al guardar en nube"); }
}

async function sincronizarConNube() {
    if (pausaSincro) return;
    try {
        const res = await fetch(SHEETS_URL);
        const data = await res.json();
        
        // 1. Actualiza Historial (Dato global)
        if (data.historial) dbHistorial = data.historial;
        
        // 2. Actualiza Cat√°logo de Defectos (Dato de configuraci√≥n)
        if (data.config && data.config.CATALOGO_DEFECTOS) {
            const catalogoNube = JSON.parse(data.config.CATALOGO_DEFECTOS);
            if (Object.keys(catalogoNube).length > 0) {
                catalogoDefectos = catalogoNube;
            }
        }

        // 3. ACTUALIZACI√ìN PROTEGIDA Y LIMPIEZA DE "FANTASMAS"
        if (data.pizarra && !document.querySelector('.modal[style*="block"]')) {
            
            data.pizarra.forEach((loteNube, i) => {
                // REGLA A: Si mi l√≠nea local est√° disponible, acepto lo que diga la nube
                if (!estados[i].activo) {
                    estados[i] = loteNube;
                } 
                // REGLA B: Si mi l√≠nea local dice que hay un lote activo...
                else {
                    // ...pero la Nube dice que esa l√≠nea ya est√° LIBRE (false)
                    // significa que mi dato local es viejo. ¬°LO LIMPIAMOS!
                    if (loteNube.activo === false) {
                        estados[i] = loteNube;
                    }
                    // Si ambos est√°n activos, no hacemos nada (mantenemos tu cron√≥metro local)
                }
            });

            // Refrescar la pantalla para ver los cambios de los otros 9 PCs
            if (typeof render === "function") render();
        }
    } catch (e) { 
        console.warn("Fallo de conexi√≥n: Trabajando con datos locales.", e); 
    }
async function prepararFin(i) {
    // 1. Guardamos el √≠ndice globalmente para que 'finalizarLote' sepa cu√°l procesar
    indexSel = i; 

    // 2. Buscamos el bot√≥n espec√≠fico para dar feedback visual
    const boton = document.getElementById(`btn-terminar-${i}`);
    
    // 3. Abrimos el modal de decisi√≥n (Aceptar/Rechazar) que ya tienes en tu HTML
    abrirModal('modal-fin');

}
// --- PASO 2: SINCRO AUTOM√ÅTICA ---
// Esto hace que la PC revise la nube cada 15 segundos
setInterval(function() {
    // Solo sincronizamos si el usuario NO est√° guardando algo en ese momento
    if (!isFinalizing) {
        console.log("Sincronizando pizarra autom√°ticamente...");
        // Llamamos a la funci√≥n que descarga los datos de la nube
        // En tu c√≥digo suele llamarse cargarEstadoPizarra() o similar
        cargarEstadoPizarraDesdeNube(); 
    }
}, 15000); // 15000 milisegundos = 15 segundos
// ... (aqu√≠ terminan tus otras funciones) ...

    // --- NUEVA FUNCI√ìN DE SINCRO AUTOM√ÅTICA ---
    function cargarEstadoPizarraDesdeNube() {
        // Si el usuario est√° guardando algo o hay un modal abierto, no interrumpimos
        const modalAbierto = document.querySelector('.modal.active') || document.querySelector('.airport-modal[style*="display: block"]');
        if (isFinalizing || pausaSincro || modalAbierto) return;

        console.log("Revisando cambios en la nube...");
        
        // Llamamos a la funci√≥n que ya tienes para traer datos
        sincronizarConNube(); 
    }

    // Activamos la revisi√≥n autom√°tica cada 15 segundos
    setInterval(cargarEstadoPizarraDesdeNube, 15000);


</script>
</body>
</html>